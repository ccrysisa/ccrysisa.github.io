<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>你所不知道的 C 语言: goto 和流程控制篇 - KZnight&#39;s Blog</title><meta name="author" content="ccrysisa">
<meta name="author-link" content="https://github.com/ccrysisa">
<meta name="description" content="
goto 在 C 語言被某些人看做是妖魔般的存在，不過實在不用這樣看待，至少在 Linux 核心原始程式碼中，goto 是大量存在 (跟你想像中不同吧)。有時不用 goto 會寫出更可怕的程式碼。
" /><meta name="keywords" content='Sysprog, C, Control flow' /><meta itemprop="name" content="你所不知道的 C 语言: goto 和流程控制篇">
<meta itemprop="description" content="
goto 在 C 語言被某些人看做是妖魔般的存在，不過實在不用這樣看待，至少在 Linux 核心原始程式碼中，goto 是大量存在 (跟你想像中不同吧)。有時不用 goto 會寫出更可怕的程式碼。
"><meta itemprop="datePublished" content="2024-04-05T11:39:34+08:00" />
<meta itemprop="dateModified" content="2024-04-18T15:25:00+08:00" />
<meta itemprop="wordCount" content="1664"><meta itemprop="image" content="https://ccrysisa.github.io/logo.png" />
<meta itemprop="keywords" content="Sysprog,C,Control flow," /><meta property="og:title" content="你所不知道的 C 语言: goto 和流程控制篇" />
<meta property="og:description" content="
goto 在 C 語言被某些人看做是妖魔般的存在，不過實在不用這樣看待，至少在 Linux 核心原始程式碼中，goto 是大量存在 (跟你想像中不同吧)。有時不用 goto 會寫出更可怕的程式碼。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ccrysisa.github.io/posts/c-control-flow/" /><meta property="og:image" content="https://ccrysisa.github.io/logo.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-05T11:39:34+08:00" />
<meta property="article:modified_time" content="2024-04-18T15:25:00+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://ccrysisa.github.io/logo.png" /><meta name="twitter:title" content="你所不知道的 C 语言: goto 和流程控制篇"/>
<meta name="twitter:description" content="
goto 在 C 語言被某些人看做是妖魔般的存在，不過實在不用這樣看待，至少在 Linux 核心原始程式碼中，goto 是大量存在 (跟你想像中不同吧)。有時不用 goto 會寫出更可怕的程式碼。
"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://ccrysisa.github.io/posts/c-control-flow/" /><link rel="prev" href="https://ccrysisa.github.io/posts/oerv-pretask/" /><link rel="next" href="https://ccrysisa.github.io/posts/rust-lifetime/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "你所不知道的 C 语言: goto 和流程控制篇",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/ccrysisa.github.io\/posts\/c-control-flow\/"
    },"genre": "posts","keywords": "Sysprog, C, Control flow","wordcount":  1664 ,
    "url": "https:\/\/ccrysisa.github.io\/posts\/c-control-flow\/","datePublished": "2024-04-05T11:39:34+08:00","dateModified": "2024-04-18T15:25:00+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "ccrysisa"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="KZnight&#39;s Blog"><img loading="lazy" src="/fixit.min.svg" data-title="KZnight&#39;s Blog" data-alt="KZnight&#39;s Blog" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">KZnight&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="KZnight&#39;s Blog"><img loading="lazy" src="/fixit.min.svg" data-title="/fixit.min.svg" data-alt="/fixit.min.svg" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">KZnight&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><span>你所不知道的 C 语言: goto 和流程控制篇</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/ccrysisa" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img loading="lazy" src="https://avatars.githubusercontent.com/u/133117003?s=400&amp;v=4" data-title="ccrysisa" data-alt="ccrysisa" class="avatar" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;ccrysisa</a></span>
          <span class="post-category">收录于 <a href="/categories/c/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> C</a>&ensp;<a href="/categories/linux-kernel-internals/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Linux Kernel Internals</a></span></div>
      <div class="post-meta-line"><span title="发布于 2024-04-05 11:39:34"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2024-04-05">2024-04-05</time></span>&nbsp;<span title="更新于 2024-04-18 15:25:00"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2024-04-18">2024-04-18</time></span>&nbsp;<span title="1664 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 1700 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 4 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#misra-c">MISRA C</a></li>
    <li><a href="#goto-没有想象中那么可怕">GOTO 没有想象中那么可怕</a></li>
    <li><a href="#switch--goto">switch &amp; goto</a></li>
    <li><a href="#do--while-0-宏">do {&hellip;} while (0) 宏</a></li>
    <li><a href="#用-goto-实作-raii-开发风格">用 goto 实作 RAII 开发风格</a></li>
    <li><a href="#检阅-c-语言规格书">检阅 C 语言规格书</a></li>
    <li><a href="#和想象中不同的-switch-case">和想象中不同的 switch-case</a></li>
    <li><a href="#duffs-device">Duff&rsquo;s Device</a></li>
    <li><a href="#co-routine-应用">co-routine 应用</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><blockquote>
<p>goto 在 C 語言被某些人看做是妖魔般的存在，不過實在不用這樣看待，至少在 Linux 核心原始程式碼中，goto 是大量存在 (跟你想像中不同吧)。有時不用 goto 會寫出更可怕的程式碼。</p>
</blockquote>
<ul>
<li><a href="https://hackmd.io/@sysprog/c-control-flow"target="_blank" rel="external nofollow noopener noreferrer">原文地址<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<p>Stack Overflow: <a href="https://stackoverflow.com/questions/46586/goto-still-considered-harmful"target="_blank" rel="external nofollow noopener noreferrer">GOTO still considered harmful?</a></p>
<h2 id="misra-c">MISRA C</h2>
<p><a href="https://caxapa.ru/thumbs/468328/misra-c-2004.pdf"target="_blank" rel="external nofollow noopener noreferrer">MISRA-C:2004</a> Guidelines for the use of the C language in critical systems</p>
<p>MISRA C 禁用 <code>goto</code> 和 <code>continue</code>，但可用 <code>break</code>:</p>
<ul>
<li><strong>Rule 14.4 (required): The goto statement shall not be used.</strong></li>
<li><strong>Rule 14.5 (required): The continue statement shall not be used.</strong></li>
<li><strong>Rule 14.6 (required): For any iteration statement there shall be at most one break statement used for loop termination.</strong></li>
</ul>
<blockquote>
<p>These rules are in the interests of good structured programming. One break statement is allowed in a loop since this allows, for example, for dual outcome loops or for optimal coding.</p>
</blockquote>
<p>Stack Overflow 上的相关讨论:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/10975722/why-continue-is-considered-as-a-c-violation-in-misra-c2004"target="_blank" rel="external nofollow noopener noreferrer">Why &ldquo;continue&rdquo; is considered as a C violation in MISRA C:2004?</a></li>
</ul>
<p>使用 goto 可能会混淆静态分析的工具 (当然使用 goto 会极大可能写出 ugly 的程式码):</p>
<blockquote>
<p>Case in point: MISRA C forbids goto statements primarily because it can mess up static analysis. Yet this rule is gratuitously followed even when no static analysis tools are used, thus yielding none of the gains that you trade off for occasionally writing ugly code.</p>
</blockquote>
<h2 id="goto-没有想象中那么可怕">GOTO 没有想象中那么可怕</h2>
<p>虽然 MISRA C 这类规范都明确禁止了使用 goto，但 goto 并没有想像中的那么可怕，在一些领域还是极具活力的。</p>
<p>在 C 语言中 goto 语句是实作错误处理的极佳选择 (如果你看过 xv6 应该不陌生)，有时不用 <code>goto</code> 可能会写出更可怕的程式码:</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="http://eli.thegreenplace.net/2009/04/27/using-goto-for-error-handling-in-c"target="_blank" rel="external nofollow noopener noreferrer">Using goto for error handling in C</a></li>
</ul>
<p>Wikipedia: <a href="https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization"target="_blank" rel="external nofollow noopener noreferrer">RAII</a></p>
<blockquote>
<p>C requires significant administrative code since it doesn&rsquo;t support exceptions, try-finally blocks, or RAII at all. A typical approach is to separate releasing of resources at the end of the function and jump there with gotos in the case of error. This way the cleanup code need not be duplicated.</p>
</blockquote>
<p>相关实作:</p>
<ul>
<li><a href="https://github.com/torvalds/linux/search?utf8=%E2%9C%93&amp;q=goto"target="_blank" rel="external nofollow noopener noreferrer">goto 在 Linux 核心广泛应用</a></li>
<li><a href="https://github.com/reyk/httpd/blob/master/httpd/httpd.c#L564"target="_blank" rel="external nofollow noopener noreferrer">OpenBSD&rsquo;s httpd</a></li>
<li>Linux kernel 里 NFS inode 验证的函数: <a href="https://github.com/torvalds/linux/blob/v5.15/fs/nfs/inode.c"target="_blank" rel="external nofollow noopener noreferrer">fs/nfs/inode.c</a></li>
</ul>
<blockquote>
<p>以 <code>goto</code> 为关键字进行检索</p>
</blockquote>
<p>Wikipedia: <a href="https://en.wikipedia.org/wiki/Goto#Common_usage_patterns"target="_blank" rel="external nofollow noopener noreferrer">Common usage patterns of Goto</a></p>
<ul>
<li>To make the code more readable and easier to follow</li>
<li>Error handling (in absence of exceptions), particularly cleanup code such as resource deallocation.</li>
</ul>
<h2 id="switch--goto">switch &amp; goto</h2>
<p><code>switch</code> 通过 jump table 的内部实作可以比大量的 <code>if-else</code> 效率更高。</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> GCC: <a href="https://gcc.gnu.org/onlinedocs/gcc/Labels-as-Values.html"target="_blank" rel="external nofollow noopener noreferrer">6.3 Labels as Values</a></li>
</ul>
<blockquote>
<p>You can get the address of a label defined in the current function (or a containing function) with the unary operator ‘&amp;&amp;’. The value has type void *.</p>
<p>To use these values, you need to be able to jump to one. This is done with the computed goto statement6, goto *exp;.</p>
</blockquote>
<p>下面这篇文章以 VM 为例子对 <code>computed goto</code>  和 <code>switch</code> 的效能进行了对比 (之前学的 RISC-V 模拟器派上用场了hhh):</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="https://eli.thegreenplace.net/2012/07/12/computed-goto-for-efficient-dispatch-tables"target="_blank" rel="external nofollow noopener noreferrer">Computed goto for efficient dispatch tables</a></li>
</ul>
<blockquote>
<p>the condition serves as an offset into a lookup table that says where to jump next.</p>
<p>To anyone with a bit of experience with assembly language programming, the computed goto immediately makes sense because it just exposes a common instruction that most modern CPU architectures have - jump through a register (aka. indirect jump).</p>
</blockquote>
<div class="details admonition note open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><p><code>computed goto</code>  比 <code>switch</code> 效能更高的原因:</p>
<ol>
<li>The switch does a bit more per iteration because of bounds checking.</li>
<li>The effects of hardware branch prediction.</li>
</ol>
<p>C99:</p>
<div class="details admonition quote open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-quote-right fa-fw" aria-hidden="true"></i>引用<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">If no converted case constant expression matches and there is no default label, no part of the switch body is executed.</div>
    </div>
  </div>
<p>因为标准的这个要求，所以编译器对于 <code>switch</code> 会生成额外的 safe 检查代码，以符合上面情形的 &ldquo;no part of the switch body is executed&rdquo; 的要求。</p>
<div class="details admonition quote open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-quote-right fa-fw" aria-hidden="true"></i>引用<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">Since the switch statement has a single &ldquo;master jump&rdquo; that dispatches all opcodes, predicting its destination is quite difficult. On the other hand, the computed goto statement is compiled into a separate jump per opcode, so given that instructions often come in pairs it&rsquo;s much easier for the branch predictor to &ldquo;home in&rdquo; on the various jumps correctly.</div>
    </div>
  </div>
<p>I can&rsquo;t say for sure which one of the two factors weighs more in the speed difference between the switch and the computed goto, but if I had to guess I&rsquo;d say it&rsquo;s the branch prediction.</p>
</div>
    </div>
  </div>
<blockquote>
<p>bounds checking 是在 switch 中執行的一個環節，每次迴圈中檢查是否有 default case 的狀況，即使程式中的 switch 沒有用到 default case，編譯期間仍會產生強制檢查的程式，所以 switch 會較 computed goto 多花一個 bounds checking 的步驟</p>
</blockquote>
<blockquote>
<p>branch prediction 的部分，switch 需要預測接下來跳到哪個分支 case，而 computed goto 則是在每個 instruction 預測下一個 instruction，這之中比較直覺的想法是 computed goto 的prediction可以根據上個指令來預測，但是 switch 的prediction每次預測沒辦法根據上個指令，因此在 branch prediction accuracy 上 computed goto 會比較高。</p>
</blockquote>
<p>所以在实际中大部分也是采取 computed goto 来实作 VM:</p>
<ul>
<li>Ruby 1.9 (YARV): also uses computed goto.</li>
<li>Dalvik (the Android Java VM): computed goto</li>
<li>Lua 5.2: uses a switch</li>
</ul>
<h2 id="do--while-0-宏">do {&hellip;} while (0) 宏</h2>
<p><strong>用于避免 dangling else，即 if 和 else 未符合预期的配对 (常见于未使用 <code>{}</code> 包裹)</strong></p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> Stack Overflow: <a href="https://stackoverflow.com/questions/1067226/c-multi-line-macro-do-while0-vs-scope-block"target="_blank" rel="external nofollow noopener noreferrer">C multi-line macro: do/while(0) vs scope block</a></li>
</ul>
<p>我写了 <a href="/posts/c-preprocessor/#do----while-0-宏">相关笔记</a> 记录在前置处理器篇。</p>
<h2 id="用-goto-实作-raii-开发风格">用 goto 实作 RAII 开发风格</h2>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="https://vilimpoc.org/research/raii-in-c/"target="_blank" rel="external nofollow noopener noreferrer">RAII in C</a></li>
</ul>
<blockquote>
<p>If you have functions or control flows that allocate resources and a
failure occurs, then goto turns out to be one of the nicest ways to
unwind all resources allocated before the point of failure.</p>
</blockquote>
<p>Linux 核心中的实作:</p>
<ul>
<li><a href="https://github.com/torvalds/linux/blob/master/mm/shmem.c"target="_blank" rel="external nofollow noopener noreferrer">shmem.c</a></li>
</ul>
<blockquote>
<p>以 <code>goto</code> 为关键字进行检索</p>
</blockquote>
<h2 id="检阅-c-语言规格书">检阅 C 语言规格书</h2>
<ul>
<li><a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1548.pdf"target="_blank" rel="external nofollow noopener noreferrer">ISO/IEC 9899:201x Committee Draft</a> 6.8.6 Jump statements</li>
</ul>
<blockquote>
<p>A jump statement causes an unconditional jump to another place.</p>
<p>The identifier in a goto statement shall name a label located somewhere in the enclosing function. A goto statement shall not jump from outside the scope of an identifier having a variably modified type to inside the scope of that identifier.</p>
</blockquote>
<p>规格书后面的例子也值得一看 (特别是当你看不懂规格书严格的英语语法想表达什么的时候 &#x1f923;)</p>
<p>相关实作:</p>
<ul>
<li>CPython 的 <a href="https://github.com/python/cpython/blob/main/Modules/_asynciomodule.c#L1711"target="_blank" rel="external nofollow noopener noreferrer">Modules/_asynciomodule.c</a></li>
</ul>
<blockquote>
<p>以 <code>goto</code> 为关键字进行检索</p>
</blockquote>
<p><a href="https://gustedt.gitlabpages.inria.fr/modern-c/"target="_blank" rel="external nofollow noopener noreferrer">Modern C</a> 作者也总结了 3 项和 <code>goto</code> 相关的规范 (大可不必视 <code>goto</code> 为洪水猛兽，毕竟我们有规范作为指导是不是):</p>
<ul>
<li>Rule 2.15.0.1: Labels for goto are visible in the whole function that contains them.</li>
<li>Rule 2.15.0.2: goto can only jump to a label inside the same function.</li>
<li>Rule 2.15.0.3: goto should not jump over variable initializations.</li>
</ul>
<h2 id="和想象中不同的-switch-case">和想象中不同的 switch-case</h2>
<p><code>switch-case</code> 语句中的 case 部分本质上是 label，所以使用其它语句 (例如 <code>if</code>) 将其包裹起来并不影响 <code>switch</code> 语句的跳转。</p>
<ul>
<li><a href="https://www.codeproject.com/Articles/100473/Something-You-May-Not-Know-About-the-Switch-Statem"target="_blank" rel="external nofollow noopener noreferrer">Something You May Not Know About the Switch Statement in C/C++</a></li>
<li><a href="http://blog.robertelder.org/switch-statements-statement-expressions/"target="_blank" rel="external nofollow noopener noreferrer">How to Get Fired Using Switch Statements &amp; Statement Expressions</a></li>
</ul>
<h2 id="duffs-device">Duff&rsquo;s Device</h2>
<blockquote>
<p>这个技巧常用于内存数据的复制，类似于 <code>memcpy</code></p>
</blockquote>
<ul>
<li><i class="fa-regular fa-square fa-fw" aria-hidden="true"></i> Wikipedia: <a href="https://en.wikipedia.org/wiki/Duff%27s_device"target="_blank" rel="external nofollow noopener noreferrer">Duff&rsquo;s Device</a></li>
<li><i class="fa-regular fa-square fa-fw" aria-hidden="true"></i> <a href="http://c-faq.com/misc/duffexpln.html"target="_blank" rel="external nofollow noopener noreferrer">Duff&rsquo;s Device 的详细解释</a></li>
<li><i class="fa-regular fa-square fa-fw" aria-hidden="true"></i> <a href="http://doc.cat-v.org/bell_labs/duffs_device"target="_blank" rel="external nofollow noopener noreferrer">Tom Duff 本人的解释</a></li>
</ul>
<h2 id="co-routine-应用">co-routine 应用</h2>
<p>Wikipedia: <a href="https://en.wikipedia.org/wiki/Coroutine"target="_blank" rel="external nofollow noopener noreferrer">Coroutine</a></p>
<p>不借助操作系统也可以实作出多工交执行的 illusion (通过 <code>switch-case</code> 黑魔法来实现 &#x1f923;)</p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2024-04-18 15:25:00">更新于 2024-04-18&nbsp;</span>
      </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/posts/c-control-flow/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇" data-hashtags="Sysprog,C,Control flow"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-hashtag="Sysprog"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇" data-description=""><i class="fa-brands fa-blogger fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇"><i class="fa-brands fa-evernote fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/sysprog/' class="post-tag">Sysprog</a><a href='/tags/c/' class="post-tag">C</a><a href='/tags/control-flow/' class="post-tag">Control flow</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/oerv-pretask/" class="post-nav-item" rel="prev" title="OERV 之 Pretask"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>OERV 之 Pretask</a>
      <a href="/posts/rust-lifetime/" class="post-nav-item" rel="next" title="Rust Lifetime: 由浅入深理解生命周期">Rust Lifetime: 由浅入深理解生命周期<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.121.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.18-lts.5"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/ccrysisa"target="_blank" rel="external nofollow noopener noreferrer">ccrysisa</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lunr/lunr.min.js" defer></script><script src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script src="/lib/lunr/lunr.zh.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":20},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js" defer></script></body>
</html>

<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>你所不知道的 C 语言: goto 和流程控制篇 - KZnight&#39;s Blog</title><meta name="author" content="ccrysisa">
<meta name="author-link" content="https://github.com/ccrysisa">
<meta name="description" content="
goto 在 C 語言被某些人看做是妖魔般的存在，不過實在不用這樣看待，至少在 Linux 核心原始程式碼中，goto 是大量存在 (跟你想像中不同吧)。有時不用 goto 會寫出更可怕的程式碼。
" /><meta name="keywords" content='Sysprog, C, Control flow' /><meta itemprop="name" content="你所不知道的 C 语言: goto 和流程控制篇">
<meta itemprop="description" content="
goto 在 C 語言被某些人看做是妖魔般的存在，不過實在不用這樣看待，至少在 Linux 核心原始程式碼中，goto 是大量存在 (跟你想像中不同吧)。有時不用 goto 會寫出更可怕的程式碼。
"><meta itemprop="datePublished" content="2024-04-05T11:39:34+08:00" />
<meta itemprop="dateModified" content="2024-04-25T19:49:18+08:00" />
<meta itemprop="wordCount" content="3827"><meta itemprop="image" content="https://ccrysisa.github.io/logo.png" />
<meta itemprop="keywords" content="Sysprog,C,Control flow," /><meta property="og:title" content="你所不知道的 C 语言: goto 和流程控制篇" />
<meta property="og:description" content="
goto 在 C 語言被某些人看做是妖魔般的存在，不過實在不用這樣看待，至少在 Linux 核心原始程式碼中，goto 是大量存在 (跟你想像中不同吧)。有時不用 goto 會寫出更可怕的程式碼。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ccrysisa.github.io/posts/c-control-flow/" /><meta property="og:image" content="https://ccrysisa.github.io/logo.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-04-05T11:39:34+08:00" />
<meta property="article:modified_time" content="2024-04-25T19:49:18+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://ccrysisa.github.io/logo.png" /><meta name="twitter:title" content="你所不知道的 C 语言: goto 和流程控制篇"/>
<meta name="twitter:description" content="
goto 在 C 語言被某些人看做是妖魔般的存在，不過實在不用這樣看待，至少在 Linux 核心原始程式碼中，goto 是大量存在 (跟你想像中不同吧)。有時不用 goto 會寫出更可怕的程式碼。
"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://ccrysisa.github.io/posts/c-control-flow/" /><link rel="prev" href="https://ccrysisa.github.io/posts/oerv-pretask/" /><link rel="next" href="https://ccrysisa.github.io/posts/rust-lifetime/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "你所不知道的 C 语言: goto 和流程控制篇",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/ccrysisa.github.io\/posts\/c-control-flow\/"
    },"genre": "posts","keywords": "Sysprog, C, Control flow","wordcount":  3827 ,
    "url": "https:\/\/ccrysisa.github.io\/posts\/c-control-flow\/","datePublished": "2024-04-05T11:39:34+08:00","dateModified": "2024-04-25T19:49:18+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "ccrysisa"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="KZnight&#39;s Blog"><img loading="lazy" src="/fixit.min.svg" data-title="KZnight&#39;s Blog" data-alt="KZnight&#39;s Blog" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">KZnight&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/friends/"
                
                
              ><i class="fa-solid fa-user-group fa-fw fa-sm" aria-hidden="true"></i> Friends</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="KZnight&#39;s Blog"><img loading="lazy" src="/fixit.min.svg" data-title="/fixit.min.svg" data-alt="/fixit.min.svg" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">KZnight&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/friends/"
                  
                  
                ><i class="fa-solid fa-user-group fa-fw fa-sm" aria-hidden="true"></i> Friends</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><span>你所不知道的 C 语言: goto 和流程控制篇</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/ccrysisa" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img loading="lazy" src="https://avatars.githubusercontent.com/u/133117003?s=400&amp;v=4" data-title="ccrysisa" data-alt="ccrysisa" class="avatar" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;ccrysisa</a></span>
          <span class="post-category">收录于 <a href="/categories/c/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> C</a>&ensp;<a href="/categories/linux-kernel-internals/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Linux Kernel Internals</a></span></div>
      <div class="post-meta-line"><span title="发布于 2024-04-05 11:39:34"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2024-04-05">2024-04-05</time></span>&nbsp;<span title="更新于 2024-04-25 19:49:18"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2024-04-25">2024-04-25</time></span>&nbsp;<span title="3827 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 3900 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 8 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#misra-c">MISRA C</a></li>
    <li><a href="#goto-没有想象中那么可怕">GOTO 没有想象中那么可怕</a></li>
    <li><a href="#switch--goto">switch &amp; goto</a></li>
    <li><a href="#do--while-0-宏">do {&hellip;} while (0) 宏</a></li>
    <li><a href="#用-goto-实作-raii-开发风格">用 goto 实作 RAII 开发风格</a></li>
    <li><a href="#检阅-c-语言规格书">检阅 C 语言规格书</a></li>
    <li><a href="#和想象中不同的-switch-case">和想象中不同的 switch-case</a></li>
    <li><a href="#duffs-device">Duff&rsquo;s Device</a></li>
    <li><a href="#co-routine-应用">co-routine 应用</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><blockquote>
<p>goto 在 C 語言被某些人看做是妖魔般的存在，不過實在不用這樣看待，至少在 Linux 核心原始程式碼中，goto 是大量存在 (跟你想像中不同吧)。有時不用 goto 會寫出更可怕的程式碼。</p>
</blockquote>
<ul>
<li><a href="https://hackmd.io/@sysprog/c-control-flow"target="_blank" rel="external nofollow noopener noreferrer">原文地址<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<p>Stack Overflow: <a href="https://stackoverflow.com/questions/46586/goto-still-considered-harmful"target="_blank" rel="external nofollow noopener noreferrer">GOTO still considered harmful?</a></p>
<h2 id="misra-c">MISRA C</h2>
<p><a href="https://caxapa.ru/thumbs/468328/misra-c-2004.pdf"target="_blank" rel="external nofollow noopener noreferrer">MISRA-C:2004</a> Guidelines for the use of the C language in critical systems</p>
<p>MISRA C 禁用 <code>goto</code> 和 <code>continue</code>，但可用 <code>break</code>:</p>
<ul>
<li><strong>Rule 14.4 (required): The goto statement shall not be used.</strong></li>
<li><strong>Rule 14.5 (required): The continue statement shall not be used.</strong></li>
<li><strong>Rule 14.6 (required): For any iteration statement there shall be at most one break statement used for loop termination.</strong></li>
</ul>
<blockquote>
<p>These rules are in the interests of good structured programming. One break statement is allowed in a loop since this allows, for example, for dual outcome loops or for optimal coding.</p>
</blockquote>
<p>Stack Overflow 上的相关讨论:</p>
<ul>
<li><a href="https://stackoverflow.com/questions/10975722/why-continue-is-considered-as-a-c-violation-in-misra-c2004"target="_blank" rel="external nofollow noopener noreferrer">Why &ldquo;continue&rdquo; is considered as a C violation in MISRA C:2004?</a></li>
</ul>
<p>使用 goto 可能会混淆静态分析的工具 (当然使用 goto 会极大可能写出 ugly 的程式码):</p>
<blockquote>
<p>Case in point: MISRA C forbids goto statements primarily because it can mess up static analysis. Yet this rule is gratuitously followed even when no static analysis tools are used, thus yielding none of the gains that you trade off for occasionally writing ugly code.</p>
</blockquote>
<h2 id="goto-没有想象中那么可怕">GOTO 没有想象中那么可怕</h2>
<p>虽然 MISRA C 这类规范都明确禁止了使用 goto，但 goto 并没有想像中的那么可怕，在一些领域还是极具活力的。</p>
<p>在 C 语言中 goto 语句是实作错误处理的极佳选择 (如果你看过 xv6 应该不陌生)，有时不用 <code>goto</code> 可能会写出更可怕的程式码:</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="http://eli.thegreenplace.net/2009/04/27/using-goto-for-error-handling-in-c"target="_blank" rel="external nofollow noopener noreferrer">Using goto for error handling in C</a></li>
</ul>
<p>Wikipedia: <a href="https://en.wikipedia.org/wiki/Resource_acquisition_is_initialization"target="_blank" rel="external nofollow noopener noreferrer">RAII</a></p>
<blockquote>
<p>C requires significant administrative code since it doesn&rsquo;t support exceptions, try-finally blocks, or RAII at all. A typical approach is to separate releasing of resources at the end of the function and jump there with gotos in the case of error. This way the cleanup code need not be duplicated.</p>
</blockquote>
<p>相关实作:</p>
<ul>
<li><a href="https://github.com/torvalds/linux/search?utf8=%E2%9C%93&amp;q=goto"target="_blank" rel="external nofollow noopener noreferrer">goto 在 Linux 核心广泛应用</a></li>
<li><a href="https://github.com/reyk/httpd/blob/master/httpd/httpd.c#L564"target="_blank" rel="external nofollow noopener noreferrer">OpenBSD&rsquo;s httpd</a></li>
<li>Linux kernel 里 NFS inode 验证的函数: <a href="https://github.com/torvalds/linux/blob/v5.15/fs/nfs/inode.c"target="_blank" rel="external nofollow noopener noreferrer">fs/nfs/inode.c</a></li>
</ul>
<blockquote>
<p>以 <code>goto</code> 为关键字进行检索</p>
</blockquote>
<p>Wikipedia: <a href="https://en.wikipedia.org/wiki/Goto#Common_usage_patterns"target="_blank" rel="external nofollow noopener noreferrer">Common usage patterns of Goto</a></p>
<ul>
<li>To make the code more readable and easier to follow</li>
<li>Error handling (in absence of exceptions), particularly cleanup code such as resource deallocation.</li>
</ul>
<h2 id="switch--goto">switch &amp; goto</h2>
<p><code>switch</code> 通过 jump table 的内部实作可以比大量的 <code>if-else</code> 效率更高。</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> GCC: <a href="https://gcc.gnu.org/onlinedocs/gcc/Labels-as-Values.html"target="_blank" rel="external nofollow noopener noreferrer">6.3 Labels as Values</a></li>
</ul>
<blockquote>
<p>You can get the address of a label defined in the current function (or a containing function) with the unary operator ‘&amp;&amp;’. The value has type void *.</p>
<p>To use these values, you need to be able to jump to one. This is done with the computed goto statement6, goto *exp;.</p>
</blockquote>
<p>下面这篇文章以 VM 为例子对 <code>computed goto</code>  和 <code>switch</code> 的效能进行了对比 (之前学的 RISC-V 模拟器派上用场了hhh):</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="https://eli.thegreenplace.net/2012/07/12/computed-goto-for-efficient-dispatch-tables"target="_blank" rel="external nofollow noopener noreferrer">Computed goto for efficient dispatch tables</a></li>
</ul>
<blockquote>
<p>the condition serves as an offset into a lookup table that says where to jump next.</p>
<p>To anyone with a bit of experience with assembly language programming, the computed goto immediately makes sense because it just exposes a common instruction that most modern CPU architectures have - jump through a register (aka. indirect jump).</p>
</blockquote>
<p><code>computed goto</code>  比 <code>switch</code> 效能更高的原因:</p>
<ol>
<li>The switch does a bit more per iteration because of bounds checking.</li>
<li>The effects of hardware branch prediction.</li>
</ol>
<p>C99:</p>
<blockquote>
<p>If no converted case constant expression matches and there is no default label, no part of the switch body is executed.</p>
</blockquote>
<p>因为标准的这个要求，所以编译器对于 <code>switch</code> 会生成额外的 safe 检查代码，以符合上面情形的 &ldquo;no part of the switch body is executed&rdquo; 的要求。</p>
<blockquote>
<p>Since the switch statement has a single &ldquo;master jump&rdquo; that dispatches all opcodes, predicting its destination is quite difficult. On the other hand, the computed goto statement is compiled into a separate jump per opcode, so given that instructions often come in pairs it&rsquo;s much easier for the branch predictor to &ldquo;home in&rdquo; on the various jumps correctly.</p>
</blockquote>
<p>作者提到，ta 个人认为分支预测是导致效能差异的主要因素:</p>
<blockquote>
<p>I can&rsquo;t say for sure which one of the two factors weighs more in the speed difference between the switch and the computed goto, but if I had to guess I&rsquo;d say it&rsquo;s the branch prediction.</p>
</blockquote>
<p>除此之外，有这篇文章的 disassembly 部分可以得知，<code>switch</code> 的底层是通过所谓的 jump table 来实作的:</p>
<div class="details admonition quote open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-quote-right fa-fw" aria-hidden="true"></i>引用<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><p>How did I figure out which part of the code handles which opcode? Note that the &ldquo;table jump&rdquo; is done with:</p>
<div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">jmpq   *0x400b20(,%rdx,8)</span></span></code></pre></td></tr></table>
</div>
</div></div>
    </div>
  </div>
<blockquote>
<p>bounds checking 是在 switch 中執行的一個環節，每次迴圈中檢查是否有 default case 的狀況，即使程式中的 switch 沒有用到 default case，編譯期間仍會產生強制檢查的程式，所以 switch 會較 computed goto 多花一個 bounds checking 的步驟</p>
</blockquote>
<blockquote>
<p>branch prediction 的部分，switch 需要預測接下來跳到哪個分支 case，而 computed goto 則是在每個 instruction 預測下一個 instruction，這之中比較直覺的想法是 computed goto 的prediction可以根據上個指令來預測，但是 switch 的prediction每次預測沒辦法根據上個指令，因此在 branch prediction accuracy 上 computed goto 會比較高。</p>
</blockquote>
<p>所以在实际中大部分也是采取 computed goto 来实作 VM:</p>
<ul>
<li>Ruby 1.9 (YARV): also uses computed goto.</li>
<li>Dalvik (the Android Java VM): computed goto</li>
<li>Lua 5.2: uses a switch</li>
</ul>
<h2 id="do--while-0-宏">do {&hellip;} while (0) 宏</h2>
<p><strong>用于避免 dangling else，即 if 和 else 未符合预期的配对 (常见于未使用 <code>{}</code> 包裹)</strong></p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> Stack Overflow: <a href="https://stackoverflow.com/questions/1067226/c-multi-line-macro-do-while0-vs-scope-block"target="_blank" rel="external nofollow noopener noreferrer">C multi-line macro: do/while(0) vs scope block</a></li>
</ul>
<p>我写了 <a href="/posts/c-preprocessor/#do----while-0-宏">相关笔记</a> 记录在前置处理器篇。</p>
<h2 id="用-goto-实作-raii-开发风格">用 goto 实作 RAII 开发风格</h2>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="https://vilimpoc.org/research/raii-in-c/"target="_blank" rel="external nofollow noopener noreferrer">RAII in C</a></li>
</ul>
<blockquote>
<p>If you have functions or control flows that allocate resources and a
failure occurs, then goto turns out to be one of the nicest ways to
unwind all resources allocated before the point of failure.</p>
</blockquote>
<p>Linux 核心中的实作:</p>
<ul>
<li><a href="https://github.com/torvalds/linux/blob/master/mm/shmem.c"target="_blank" rel="external nofollow noopener noreferrer">shmem.c</a></li>
</ul>
<blockquote>
<p>以 <code>goto</code> 为关键字进行检索</p>
</blockquote>
<h2 id="检阅-c-语言规格书">检阅 C 语言规格书</h2>
<ul>
<li><a href="http://www.open-std.org/jtc1/sc22/wg14/www/docs/n1548.pdf"target="_blank" rel="external nofollow noopener noreferrer">ISO/IEC 9899:201x Committee Draft</a> 6.8.6 Jump statements</li>
</ul>
<blockquote>
<p>A jump statement causes an unconditional jump to another place.</p>
<p>The identifier in a goto statement shall name a label located somewhere in the enclosing function. A goto statement shall not jump from outside the scope of an identifier having a variably modified type to inside the scope of that identifier.</p>
</blockquote>
<p>规格书后面的例子也值得一看 (特别是当你看不懂规格书严格的英语语法想表达什么的时候 &#x1f923;)</p>
<p>从规格书中也可以得知，<code>goto</code> 虽然是无条件跳转 (对应汇编语言的 <code>jmp</code> 这类无条件跳转指令)，但它的跳转范围是有限制的 (jump to another place)，而不是可以跳转到任意程式码 (这也是为什么 <code>setjmp/longjmp</code> 被称为「长跳转」的原因，与 <code>goto</code> 这类「短跳转」相对应)。</p>
<p>相关实作:</p>
<ul>
<li>CPython 的 <a href="https://github.com/python/cpython/blob/main/Modules/_asynciomodule.c#L1711"target="_blank" rel="external nofollow noopener noreferrer">Modules/_asynciomodule.c</a></li>
</ul>
<blockquote>
<p>以 <code>goto</code> 为关键字进行检索</p>
</blockquote>
<p><a href="https://gustedt.gitlabpages.inria.fr/modern-c/"target="_blank" rel="external nofollow noopener noreferrer">Modern C</a> 作者也总结了 3 项和 <code>goto</code> 相关的规范 (大可不必视 <code>goto</code> 为洪水猛兽，毕竟我们有规范作为指导是不是):</p>
<ul>
<li>Rule 2.15.0.1: Labels for goto are visible in the whole function that contains them.</li>
<li>Rule 2.15.0.2: goto can only jump to a label inside the same function.</li>
<li>Rule 2.15.0.3: goto should not jump over variable initializations.</li>
</ul>
<h2 id="和想象中不同的-switch-case">和想象中不同的 switch-case</h2>
<p><code>switch-case</code> 语句中的 case 部分本质上是 label，所以使用其它语句 (例如 <code>if</code>) 将其包裹起来并不影响 <code>switch</code> 语句的跳转。所以将 <code>swicth-case</code> 的 <code>case</code> 部分用 <code>if (0)</code> 包裹起来就无需使用 <code>break</code> 来进行跳出了:</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">switch</span> <span class="p">(</span><span class="n">argc</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">             <span class="k">case</span>  <span class="mi">0</span><span class="o">:</span> <span class="n">num</span> <span class="o">=</span>  <span class="s">&#34;zero&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">case</span>  <span class="mi">1</span><span class="o">:</span> <span class="n">num</span> <span class="o">=</span>   <span class="s">&#34;one&#34;</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">case</span>  <span class="mi">2</span><span class="o">:</span> <span class="n">num</span> <span class="o">=</span>   <span class="s">&#34;two&#34;</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">case</span>  <span class="mi">3</span><span class="o">:</span> <span class="n">num</span> <span class="o">=</span> <span class="s">&#34;three&#34;</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="k">default</span><span class="o">:</span> <span class="n">num</span> <span class="o">=</span>  <span class="s">&#34;many&#34;</span><span class="p">;</span> <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>归纳一下，这种实作方法符合以下结构:</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span> <span class="nl">label</span><span class="p">:</span> <span class="p">...</span> <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="https://clifford.at/cliffords-device.html"target="_blank" rel="external nofollow noopener noreferrer">Clifford’s Device</a></li>
</ul>
<blockquote>
<p>A <strong>Clifford&rsquo;s Device</strong> is a section of code is surrounded by <code>if (0) { label: … }</code> so it is skipped in the normal flow of execution and is only reached via the goto label, reintegrating with the normal flow of execution and the end of the <code>if (0)</code> statement. It solves a situation where one would usually need to duplicate code or create a state variable holding the information if the additional code block should be called.</p>
</blockquote>
<blockquote>
<p>A switch statement is nothing else than a computed goto statement. So it is possible to use Clifford&rsquo;s Device with a switch statement as well.</p>
</blockquote>
<p>简单来说，这种方法主要用于开发阶段时的运行时信息输出，在发行阶段运行时不再输出这一信息的情景，有助于开发时程序员进行侦错。除此之外，在使用枚举作为 <code>switch-case</code> 的表达式时，如果 <code>case</code> 没有对全部的枚举值进行处理的话，编译器会给出警告 (Rust 警告 &#x1f923; 但 Rust 会直接报错)，使用 <code>if (0) { ... }</code> 技巧将未处理的枚举值对应的 <code>case</code> 包裹就不会出现警告，同时也不影响代码逻辑。</p>
<p>在 OpenSSL 中也有类似手法的实作:</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ok</span><span class="p">)</span> <span class="k">goto</span> <span class="n">end</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="nl">end</span><span class="p">:</span>
</span></span><span class="line"><span class="cl">        <span class="nf">X509_get_pubkey_parameters</span><span class="p">(</span><span class="nb">NULL</span><span class="p">,</span> <span class="n">ctx</span><span class="o">-&gt;</span><span class="n">chain</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><a href="https://www.codeproject.com/Articles/100473/Something-You-May-Not-Know-About-the-Switch-Statem"target="_blank" rel="external nofollow noopener noreferrer">Something You May Not Know About the Switch Statement in C/C++</a></li>
<li><a href="http://blog.robertelder.org/switch-statements-statement-expressions/"target="_blank" rel="external nofollow noopener noreferrer">How to Get Fired Using Switch Statements &amp; Statement Expressions</a></li>
</ul>
<h2 id="duffs-device">Duff&rsquo;s Device</h2>
<p>这个技巧常用于内存数据的复制，类似于 <code>memcpy</code>。主要思路类似于在数值系统篇提到的 <code>strcpy</code>，针对 alignment 和 unalignment 的情况分别进行相应的处理，但效能比不上优化过的 <code>memcpy</code>。</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> Wikipedia: <a href="https://en.wikipedia.org/wiki/Duff%27s_device"target="_blank" rel="external nofollow noopener noreferrer">Duff&rsquo;s Device</a></li>
</ul>
<blockquote>
<p>To handle cases where the number of iterations is not divisible by the unrolled-loop increments, a common technique among assembly language programmers is to jump directly into the middle of the unrolled loop body to handle the remainder. Duff implemented this technique in C by using C&rsquo;s case label fall-through feature to jump into the unrolled body.</p>
</blockquote>
<p>Linux 核心中的实作运用:</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">dsend</span><span class="p">(</span><span class="kt">int</span> <span class="n">count</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">count</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="p">(</span><span class="n">count</span> <span class="o">+</span> <span class="mi">7</span><span class="p">)</span> <span class="o">/</span> <span class="mi">8</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">count</span> <span class="o">%</span> <span class="mi">8</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">        <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;case 0&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">7</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;case 7&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">6</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;case 6&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">5</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;case 5&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">4</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;case 4&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">3</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;case 3&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;case 2&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">            <span class="nf">puts</span><span class="p">(</span><span class="s">&#34;case 1&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="o">--</span><span class="n">n</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>试着将上面这段程式码修改为 <code>memcpy</code> 功能的实作，进一步体会 Duff&rsquo;s Device 的核心机制，同时结合「<a href="https://hackmd.io/@sysprog/c-memory"target="_blank" rel="external nofollow noopener noreferrer">C语言: 内存管理篇</a>」思考为什么该实作效能不高。</p>
<details>
  <summary>Answer</summary>
  未充分利用 data alignment 和现代处理器的寄存器大小，每次只处理一个 byte 导致效率低下。
</details>
<ul>
<li><i class="fa-regular fa-square fa-fw" aria-hidden="true"></i> <a href="http://c-faq.com/misc/duffexpln.html"target="_blank" rel="external nofollow noopener noreferrer">Duff&rsquo;s Device 的详细解释</a></li>
<li><i class="fa-regular fa-square fa-fw" aria-hidden="true"></i> <a href="http://doc.cat-v.org/bell_labs/duffs_device"target="_blank" rel="external nofollow noopener noreferrer">Tom Duff 本人的解释</a></li>
</ul>
<div class="details admonition quote open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-quote-right fa-fw" aria-hidden="true"></i>引用<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><p>但在現代的微處理器中，Duff&rsquo;s Device 不見得會帶來好處，改用已針對處理器架構最佳化的 memcpy 函式，例如 Linux 核心的修改 fbdev: Improve performance of sys_fillrect()</p>
<ul>
<li>使用 Duff&rsquo;s Device 的 sys_fillrect(): 166,603 cycles</li>
<li>運用已最佳化 memcpy 的 sys_fillrect(): 26,586 cycles</li>
</ul></div>
    </div>
  </div>
<h2 id="co-routine-应用">co-routine 应用</h2>
<p>Wikipedia: <a href="https://en.wikipedia.org/wiki/Coroutine"target="_blank" rel="external nofollow noopener noreferrer">Coroutine</a></p>
<p>不借助操作系统也可以实作出多工交执行的 illusion (通过 <code>switch-case</code> 黑魔法来实现 &#x1f923;)</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> PuTTY 作者 Simon Tatham: <a href="https://www.chiark.greenend.org.uk/~sgtatham/coroutines.html"target="_blank" rel="external nofollow noopener noreferrer">Coroutines in C</a></li>
</ul>
<div class="details admonition note open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">这是一篇好文章，下面我对文章画一些重点</div>
    </div>
  </div>
<blockquote>
<p>In The Art of Computer Programming, Donald Knuth presents a solution to this sort of problem. His answer is to throw away the stack concept completely. Stop thinking of one process as the caller and the other as the callee, and start thinking of them as cooperating equals.</p>
</blockquote>
<blockquote>
<p>The callee has all the problems. For our callee, we want a function which has a &ldquo;return and continue&rdquo; operation: return from the function, and next time it is called, resume control from just after the return statement. For example, we would like to be able to write a function that says</p>
</blockquote>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">function</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">i</span><span class="p">;</span>   <span class="cm">/* won&#39;t work, but wouldn&#39;t it be nice */</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>and have ten successive calls to the function return the numbers 0 through 9.</p>
</blockquote>
<blockquote>
<p>How can we implement this? Well, we can transfer control to an arbitrary point in the function using a goto statement. So if we use a state variable, we could do this:</p>
</blockquote>
<div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">function</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="k">goto</span> <span class="n">LABEL0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">1</span><span class="o">:</span> <span class="k">goto</span> <span class="n">LABEL1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="nl">LABEL0</span><span class="p">:</span> <span class="cm">/* start of function */</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* so we will come back to LABEL1 */</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="nl">LABEL1</span><span class="p">:;</span> <span class="cm">/* resume control straight after the return */</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个实作里面，<code>staic</code> 这个修饰词也起到了很大作用，尝试带入一个流程去体会 <code>static</code> 在这段程式码的作用，并试着想一下如果没有 <code>static</code> 修饰变量 <code>i</code> 和 <code>state</code> 会导致上面后果。</p>
<blockquote>
<p>The famous &ldquo;Duff&rsquo;s device&rdquo; in C makes use of the fact that a case statement is still legal within a sub-block of its matching switch statement.</p>
</blockquote>
<blockquote>
<p>We can put it to a slightly different use in the coroutine trick. Instead of using a switch statement to decide which goto statement to execute, we can use the switch statement to perform the jump itself:</p>
</blockquote>
<div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">function</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="n">i</span><span class="p">,</span> <span class="n">state</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">switch</span> <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">case</span> <span class="mi">0</span><span class="o">:</span> <span class="cm">/* start of function */</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">state</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* so we will come back to &#34;case 1&#34; */</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span><span class="p">;</span> <span class="cm">/* resume control straight after the return */</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><blockquote>
<p>Now this is looking promising. All we have to do now is construct a few well chosen macros, and we can hide the gory details in something plausible-looking:</p>
</blockquote>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define crBegin static int state=0; switch(state) { case 0:
</span></span></span><span class="line"><span class="cl"><span class="cp">#define crReturn(i,x) do { state=i; return x; case i:; } while (0)
</span></span></span><span class="line"><span class="cl"><span class="cp">#define crFinish }
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">int</span> <span class="nf">function</span><span class="p">(</span><span class="kt">void</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">static</span> <span class="kt">int</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">crBegin</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="nf">crReturn</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">crFinish</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里又用到了 <code>do { ... } while (0)</code> 搭配宏的技巧 &#x1f923;</p>
<blockquote>
<p>The only snag remaining is the first parameter to crReturn. Just as when we invented a new label in the previous section we had to avoid it colliding with existing label names, now we must ensure all our state parameters to crReturn are different. The consequences will be fairly benign - the compiler will catch it and not let it do horrible things at run time - but we still need to avoid doing it.</p>
</blockquote>
<blockquote>
<p>Even this can be solved. ANSI C provides the special macro name <strong>LINE</strong>, which expands to the current source line number. So we can rewrite crReturn as</p>
</blockquote>
<div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define crReturn(x) do { state=__LINE__; return x; \
</span></span></span><span class="line"><span class="cl"><span class="cp">                         case __LINE__:; } while (0)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个实作手法本质上和 Knuth 所提的机制相同，将函数的状态存储在其它地方而不是存放在 stack 上，这里存储的地方就是之前所提的那些被 <code>static</code> 修饰的变量 (因为 <code>static</code> 修饰的变量存储在 data 段而不在栈上)，事实上这些 <code>static</code> 变量实现了一个小型的状态机。</p>
<blockquote>
<p>We have achieved what we set out to achieve: a portable ANSI C means of passing data between a producer and a consumer without the need to rewrite one as an explicit state machine. We have done this by combining the C preprocessor with a little-used feature of the switch statement to create an implicit state machine.</p>
</blockquote>
<p><code>static</code> 变量的表达能力有限，但是可以通过预先分配空间，并通过指针操作取代 <code>static</code> 变量操作来实现 coroutine 的可重入性:</p>
<blockquote>
<p>In a serious application, this toy coroutine implementation is unlikely to be useful, because it relies on static variables and so it fails to be re-entrant or multi-threadable. Ideally, in a real application, you would want to be able to call the same function in several different contexts, and at each call in a given context, have control resume just after the last return in the same context.</p>
</blockquote>
<blockquote>
<p>This is easily enough done. We arrange an extra function parameter, which is a pointer to a context structure; we declare all our local state, and our coroutine state variable, as elements of that structure.</p>
</blockquote>
<blockquote>
<p>It&rsquo;s a little bit ugly, because suddenly you have to use ctx-&gt;i as a loop counter where you would previously just have used i; virtually all your serious variables become elements of the coroutine context structure. But it removes the problems with re-entrancy, and still hasn&rsquo;t impacted the structure of the routine.</p>
</blockquote>
<p>作者最后提供了相关实作:</p>
<ul>
<li><a href="https://www.chiark.greenend.org.uk/~sgtatham/coroutine.h"target="_blank" rel="external nofollow noopener noreferrer">coroutine.h</a></li>
</ul>
<hr>
<p>在 PuTTY 里的相关实作:</p>
<ul>
<li><a href="https://github.com/Yasushi/putty/blob/31a2ad775f393aad1c31a983b0baea205d48e219/ssh.c#L414"target="_blank" rel="external nofollow noopener noreferrer">ssh.c</a></li>
</ul>
<p>将原文的「合作式多工」中的 <code>cr_yield</code> 宏使用 <code>do { ... } while (0)</code> 手法改写：</p>
<div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define cr_yield()               \
</span></span></span><span class="line"><span class="cl"><span class="cp">    do {                         \
</span></span></span><span class="line"><span class="cl"><span class="cp">        __s = __LINE__;          \
</span></span></span><span class="line"><span class="cl"><span class="cp">        usleep(THREAD_INTERVAL); \
</span></span></span><span class="line"><span class="cl"><span class="cp">        return;                  \
</span></span></span><span class="line"><span class="cl"><span class="cp">    case __LINE__:;              \
</span></span></span><span class="line"><span class="cl"><span class="cp">    } while (0)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>延伸阅读:</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="https://airfishqi.blogspot.com/2016/11/switch-case.html"target="_blank" rel="external nofollow noopener noreferrer">深入了解 switch-case</a></li>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="https://dunkels.com/adam/pt/"target="_blank" rel="external nofollow noopener noreferrer">Protothreads</a></li>
</ul></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2024-04-25 19:49:18">更新于 2024-04-25&nbsp;</span>
      </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/posts/c-control-flow/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇" data-hashtags="Sysprog,C,Control flow"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-hashtag="Sysprog"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇" data-description=""><i class="fa-brands fa-blogger fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://ccrysisa.github.io/posts/c-control-flow/" data-title="你所不知道的 C 语言: goto 和流程控制篇"><i class="fa-brands fa-evernote fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/sysprog/' class="post-tag">Sysprog</a><a href='/tags/c/' class="post-tag">C</a><a href='/tags/control-flow/' class="post-tag">Control flow</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/oerv-pretask/" class="post-nav-item" rel="prev" title="OERV 之 Pretask"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>OERV 之 Pretask</a>
      <a href="/posts/rust-lifetime/" class="post-nav-item" rel="next" title="Rust Lifetime: 由浅入深理解生命周期">Rust Lifetime: 由浅入深理解生命周期<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.121.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.18-lts.5"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/ccrysisa"target="_blank" rel="external nofollow noopener noreferrer">ccrysisa</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lunr/lunr.min.js" defer></script><script src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script src="/lib/lunr/lunr.zh.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":30},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js" defer></script></body>
</html>

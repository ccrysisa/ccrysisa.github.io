<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>你所不知道的 C 语言: bitwise 操作 - KZnight&#39;s Blog</title><meta name="author" content="ccrysisa">
<meta name="author-link" content="https://github.com/ccrysisa">
<meta name="description" content="
Linux 核心原始程式码存在大量 bit(-wise) operations (简称 bitops)，颇多乍看像是魔法的 C 程式码就是 bitops 的组合。
" /><meta name="keywords" content='Sysprog, C, Bitwise' /><meta itemprop="name" content="你所不知道的 C 语言: bitwise 操作">
<meta itemprop="description" content="
Linux 核心原始程式码存在大量 bit(-wise) operations (简称 bitops)，颇多乍看像是魔法的 C 程式码就是 bitops 的组合。
"><meta itemprop="datePublished" content="2024-02-23T13:13:33+08:00" />
<meta itemprop="dateModified" content="2024-03-24T13:40:19+08:00" />
<<<<<<< HEAD
<meta itemprop="wordCount" content="3990"><meta itemprop="image" content="https://ccrysisa.github.io/logo.png" />
=======
<meta itemprop="wordCount" content="6289"><meta itemprop="image" content="https://ccrysisa.github.io/logo.png" />
>>>>>>> ca918a0972dc3c7d155998c5dfa36a48f678343b
<meta itemprop="keywords" content="Sysprog,C,Bitwise," /><meta property="og:title" content="你所不知道的 C 语言: bitwise 操作" />
<meta property="og:description" content="
Linux 核心原始程式码存在大量 bit(-wise) operations (简称 bitops)，颇多乍看像是魔法的 C 程式码就是 bitops 的组合。
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ccrysisa.github.io/posts/c-bitwise/" /><meta property="og:image" content="https://ccrysisa.github.io/logo.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-23T13:13:33+08:00" />
<meta property="article:modified_time" content="2024-03-24T13:40:19+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://ccrysisa.github.io/logo.png" /><meta name="twitter:title" content="你所不知道的 C 语言: bitwise 操作"/>
<meta name="twitter:description" content="
Linux 核心原始程式码存在大量 bit(-wise) operations (简称 bitops)，颇多乍看像是魔法的 C 程式码就是 bitops 的组合。
"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://ccrysisa.github.io/posts/c-bitwise/" /><link rel="prev" href="https://ccrysisa.github.io/posts/smart-pointers-and-interior-mutability/" /><link rel="next" href="https://ccrysisa.github.io/posts/c-memory/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "你所不知道的 C 语言: bitwise 操作",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/ccrysisa.github.io\/posts\/c-bitwise\/"
<<<<<<< HEAD
    },"genre": "posts","keywords": "Sysprog, C, Bitwise","wordcount":  3990 ,
=======
    },"genre": "posts","keywords": "Sysprog, C, Bitwise","wordcount":  6289 ,
>>>>>>> ca918a0972dc3c7d155998c5dfa36a48f678343b
    "url": "https:\/\/ccrysisa.github.io\/posts\/c-bitwise\/","datePublished": "2024-02-23T13:13:33+08:00","dateModified": "2024-03-24T13:40:19+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "ccrysisa"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="KZnight&#39;s Blog"><img loading="lazy" src="/fixit.min.svg" alt="KZnight&#39;s Blog" data-title="KZnight&#39;s Blog" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">KZnight&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="KZnight&#39;s Blog"><img loading="lazy" src="/fixit.min.svg" alt="/fixit.min.svg" data-title="/fixit.min.svg" class="logo" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">KZnight&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="aside-collection animate__animated animate__fadeIn animate__faster" aria-label="合集"></aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><span>你所不知道的 C 语言: bitwise 操作</span>
      </h1></div><div class="post-meta">
<<<<<<< HEAD
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/ccrysisa" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img loading="lazy" src="https://avatars.githubusercontent.com/u/133117003?s=400&amp;v=4" alt="ccrysisa" data-title="ccrysisa" class="avatar" style="background: url(/images/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;for(const i of ['style', 'data-title','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;ccrysisa</a></span><span class="post-included-in">&nbsp;收录于 <a href="/categories/c/" class="post-category" title="分类 - C"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> C</a>&ensp;<a href="/categories/linux-kernel-internals/" class="post-category" title="分类 - Linux Kernel Internals"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Linux Kernel Internals</a></span></div><div class="post-meta-line"><span title="发布于 2024-02-23 13:13:33"><i class="fa-solid fa-calendar-days fa-fw me-1" aria-hidden="true"></i><time datetime="2024-02-23">2024-02-23</time></span>&nbsp;<span title="更新于 2024-03-24 13:40:19"><i class="fa-regular fa-calendar-check fa-fw me-1" aria-hidden="true"></i><time datetime="2024-03-24">2024-03-24</time></span>&nbsp;<span title="3990 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 4000 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 8 分钟</span>&nbsp;</div>
=======
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/ccrysisa" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img loading="lazy" src="https://avatars.githubusercontent.com/u/133117003?s=400&amp;v=4" data-title="ccrysisa" data-alt="ccrysisa" class="avatar" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;ccrysisa</a></span>
          <span class="post-category">收录于 <a href="/categories/c/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> C</a>&ensp;<a href="/categories/linux-kernel-internals/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Linux Kernel Internals</a></span></div>
      <div class="post-meta-line"><span title="发布于 2024-02-23 13:13:33"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2024-02-23">2024-02-23</time></span>&nbsp;<span title="更新于 2024-03-24 13:40:19"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2024-03-24">2024-03-24</time></span>&nbsp;<span title="6289 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 6300 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 13 分钟</span>&nbsp;</div>
>>>>>>> ca918a0972dc3c7d155998c5dfa36a48f678343b
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#复习数值系统">复习数值系统</a>
      <ul>
        <li><a href="#位元组合">位元组合</a></li>
        <li><a href="#位移运算">位移运算</a></li>
        <li><a href="#signed--unsigned">Signed &amp; Unsigned</a></li>
        <li><a href="#sign-extension">Sign Extension</a></li>
      </ul>
    </li>
    <li><a href="#bitwise-operator">Bitwise Operator</a>
      <ul>
        <li><a href="#bitwise--logical">bitwise &amp; logical</a></li>
        <li><a href="#right-shifts">Right Shifts</a></li>
      </ul>
    </li>
    <li><a href="#bitwise-实作">bitwise 实作</a>
      <ul>
        <li><a href="#set-a-bit">Set a bit</a></li>
        <li><a href="#clear-a-bit">Clear a bit</a></li>
        <li><a href="#toggle-a-bit">Toggle a bit</a></li>
        <li><a href="#test-a-bit">Test a bit</a></li>
        <li><a href="#the-rightleft-most-byte">The right/left most byte</a></li>
        <li><a href="#sign-bit">Sign bit</a></li>
        <li><a href="#uses-of-bitwise-operations-or-why-to-study-bits">Uses of Bitwise Operations or Why to Study Bits</a></li>
      </ul>
    </li>
    <li><a href="#影像处理">影像处理</a>
      <ul>
        <li><a href="#案例分析">案例分析</a></li>
      </ul>
    </li>
    <li><a href="#案例探讨">案例探讨</a></li>
    <li><a href="#类神经网络的-relu-极其常数时间复杂度实作">类神经网络的 ReLU 极其常数时间复杂度实作</a></li>
    <li><a href="#从-sqrt-2-的存在谈开平方根的快速运算">从 $\sqrt 2$ 的存在谈开平方根的快速运算</a>
      <ul>
        <li><a href="#sqrt-2-的缘起和计算">$\sqrt 2$ 的缘起和计算</a></li>
        <li><a href="#固定点和牛顿法">固定点和牛顿法</a></li>
        <li><a href="#二进位的平方根">二进位的平方根</a></li>
        <li><a href="#fast-inverse-square-root-平方根倒数">Fast Inverse Square Root (平方根倒数)</a></li>
      </ul>
    </li>
    <li><a href="#c-语言的-bit-field">C 语言的 bit-field</a>
      <ul>
        <li><a href="#linux-核心-build_bug_on_zero">Linux 核心: BUILD_BUG_ON_ZERO()</a></li>
      </ul>
    </li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><blockquote>
<p>Linux 核心原始程式码存在大量 bit(-wise) operations (简称 bitops)，颇多乍看像是魔法的 C 程式码就是 bitops 的组合。</p>
</blockquote>
<ul>
<li><a href="https://hackmd.io/@sysprog/c-bitwise"target="_blank" rel="external nofollow noopener noreferrer">原文地址<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<h2 id="复习数值系统" class="heading-element">
  <a href="#%e5%a4%8d%e4%b9%a0%e6%95%b0%e5%80%bc%e7%b3%bb%e7%bb%9f" class="heading-mark"></a>复习数值系统</h2><ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> YouTube: <a href="https://www.youtube.com/watch?v=8J7sAYoG50A"target="_blank" rel="external nofollow noopener noreferrer">十进制，十二进制，六十进制从何而来？阿拉伯人成就了文艺复兴？[数学大师]</a></li>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="https://hackmd.io/@sysprog/c-numerics"target="_blank" rel="external nofollow noopener noreferrer">你所不知道的 C 语言: 数值系统</a></li>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="https://hackmd.io/@sysprog/binary-representation"target="_blank" rel="external nofollow noopener noreferrer">解读计算机编码</a></li>
</ul>
<h3 id="位元组合" class="heading-element">
  <a href="#%e4%bd%8d%e5%85%83%e7%bb%84%e5%90%88" class="heading-mark"></a>位元组合</h3><p>一些位元组合表示特定的意义，而不是表示数值，这些组合被称为 <strong>trap representation</strong></p>
<ul>
<li>C11 6.2.6.2 Integer types</li>
</ul>
<blockquote>
<p>For unsigned integer types other than unsigned char, the bits of the object representation shall be divided into two groups: value bits and padding bits (there need not be any of the latter). If there are N value bits, each bit shall represent a different power of 2 between 1 and 2N−1, so that objects of that type shall be capable of representing values from 0 to 2N−1 using a pure binary representation; this shall be known as the value representation. The values of any padding bits are unspecified.</p>
</blockquote>
<p><code>uintN_t</code> 和 <code>intN_t</code> 保证没有填充位元 (padding bits)，且 <code>intN_t</code> 是二补数编码，所以对这两种类型进行位操作是安全的。</p>
<ul>
<li>C99 7.18.1.1 Exact-width integer types</li>
</ul>
<blockquote>
<p>The typedef name intN_t designates a signed integer type with width N, no padding bits, and a two’s complement representation.</p>
</blockquote>
<div class="details admonition info open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-info-circle fa-fw" aria-hidden="true"></i>信息<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><p>有符号整数上也有可能产生陷阱表示法 (trap representation)</p>
<p>补充资讯: <a href="https://csapp.cs.cmu.edu/3e/waside/waside-tmin.pdf"target="_blank" rel="external nofollow noopener noreferrer">CS:APP Web Aside DATA:TMIN: Writing TMin in C</a></p>
</div>
    </div>
  </div>
<h3 id="位移运算" class="heading-element">
  <a href="#%e4%bd%8d%e7%a7%bb%e8%bf%90%e7%ae%97" class="heading-mark"></a>位移运算</h3><p>位移运算的未定义情况:</p>
<p><strong>C99 6.5.7 Bitwise shift operators</strong></p>
<ul>
<li>左移超过变量长度，则运算结果未定义</li>
</ul>
<blockquote>
<p>If the value of the right operand is negative or is greater than or equal to the width of the promoted left operand, the behavior is undefined.</p>
</blockquote>
<ul>
<li>对一个负数进行右移，C 语言规格未定义，作为 implementation-defined，GCC 实作为算术位移 (arithmetic shift)</li>
</ul>
<blockquote>
<p>If E1 has a signed type and a negative value, the resulting value is implementation-defined.</p>
</blockquote>
<h3 id="signed--unsigned" class="heading-element">
  <a href="#signed--unsigned" class="heading-mark"></a>Signed &amp; Unsigned</h3><p>当 Unsigned 和 Signed 混合在同一表达式时，Signed 会被转换成 Unsigned，运算结果可能不符合我们的预期 (这里大赞 Rust，这种情况会编译失败&#x1f923;)。案例请参考原文，这里举一个比较常见的例子:</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="k">for</span> <span class="p">(</span><span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="n">n</span> <span class="o">-</span> <span class="mi">1</span> <span class="p">;</span> <span class="n">i</span> <span class="o">-</span> <span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span><span class="o">--</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;i: 0x%x</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span><span class="n">i</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这段程式码会导致无限循环，因为条件判断语句 <code>i - sizeof(char) &gt;= 0</code> 恒为真 (变量 i 被转换成 Unsigned 了)。</p>
<ul>
<li>6.5.3.4 The sizeof operator</li>
</ul>
<blockquote>
<p>The value of the result is implementation-defined, and its type (an unsigned integer type) is size_t, defined in &lt;stddef.h&gt; (and other headers).</p>
</blockquote>
<ul>
<li>7.17 Common definitions &lt;stddef.h&gt;</li>
</ul>
<blockquote>
<p><code>size_t</code> which is the unsigned integer type of the result of the sizeof operator</p>
</blockquote>
<h3 id="sign-extension" class="heading-element">
  <a href="#sign-extension" class="heading-mark"></a>Sign Extension</h3><p>将 w bit signed integer 扩展为 w+k bit signed integer，只需将 sign bit 补充至扩展的 bits。</p>
<p>数值等价性推导:</p>
<ul>
<li>positive: 显然是正确的，sign bit 为 0，扩展后数值仍等于原数值</li>
<li>negitive: 将 w bit 情形时的除开 sign bit 的数值设为 U，则原数值为 $2^{-(w-1)} + U$，则扩展为 w+k bit 后数值为 $2^{-(w+k-1)} + 2^{w+k-2} + &hellip; + 2^{-(w-1)} + U$，因为 $2^{-(w+k-1)} + 2^{w+k-2} + &hellip; + 2^{w-1} = 2^{-(w-1)}$，所以数值依然等价。</li>
</ul>
<blockquote>
<p>$2^{-(w+k-1)} + 2^{w+k-2} + &hellip; + 2^{w-1}$ 可以考虑从左往右的运算，每次都是将原先的数值减半，所以最后的数值为 $2^{-(w+k-1)}$</p>
</blockquote>
<p>所以如果 n 是 signed 32-bit，则 <code>n &gt;&gt; 31</code> 等价于 <code>n == 0 ? 0 : -1</code>。在这个的基础上，请重新阅读 <a href="https://hackmd.io/@sysprog/binary-representation"target="_blank" rel="external nofollow noopener noreferrer">解读计算机编码</a> 中的 abs 和 min/max 的常数时间实作。</p>
<h2 id="bitwise-operator" class="heading-element">
  <a href="#bitwise-operator" class="heading-mark"></a>Bitwise Operator</h2><ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="http://doc.callmematthi.eu/C_Bitwise_Operators.html"target="_blank" rel="external nofollow noopener noreferrer">Bitwise Operators Quiz Answers</a></li>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="https://pconrad.github.io/old_pconrad_cs16/topics/bitOps/"target="_blank" rel="external nofollow noopener noreferrer">Practice with bit operations</a></li>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> <a href="https://web.stanford.edu/class/archive/cs/cs107/cs107.1202/lab1/practice.html"target="_blank" rel="external nofollow noopener noreferrer">Bitwise Practice</a></li>
</ul>
<blockquote>
<p>Each lowercase letter is 32 + uppercase equivalent. This means simply flipping the bit at position 5 (counting from least significant bit at position 0) inverts the case of a letter.</p>
</blockquote>
<blockquote>
<p>The gdb print command (shortened p) defaults to decimal format. Use <code>p/format</code> to instead select other formats such as <code>x</code> for hex, <code>t</code> for binary, and <code>c</code> for char.</p>
</blockquote>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// unsigned integer `mine`, `yours`
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">remove</span> <span class="n">yours</span> <span class="n">from</span> <span class="n">mine</span>                            <span class="n">mine</span> <span class="o">=</span> <span class="n">mine</span> <span class="o">&amp;</span> <span class="o">~</span><span class="n">yours</span>
</span></span><span class="line"><span class="cl"><span class="n">test</span> <span class="k">if</span> <span class="n">mine</span> <span class="n">has</span> <span class="n">both</span> <span class="n">of</span> <span class="n">two</span> <span class="n">lowest</span> <span class="n">bits</span> <span class="nf">on</span>       <span class="p">(</span><span class="n">mine</span> <span class="o">&amp;</span> <span class="mh">0x3</span><span class="p">)</span> <span class="o">==</span> <span class="mh">0x3</span>
</span></span><span class="line"><span class="cl"><span class="n">n</span> <span class="n">least</span> <span class="n">significant</span> <span class="n">bits</span> <span class="n">on</span><span class="p">,</span> <span class="n">all</span> <span class="n">others</span> <span class="nf">off</span>       <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>
</span></span><span class="line"><span class="cl"><span class="n">k</span> <span class="n">most</span> <span class="n">significant</span> <span class="n">bits</span> <span class="n">on</span><span class="p">,</span> <span class="n">all</span> <span class="n">others</span> <span class="nf">off</span>        <span class="p">(</span><span class="o">~</span><span class="mi">0</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">k</span><span class="p">))</span> <span class="n">or</span>
</span></span><span class="line"><span class="cl">                                                  <span class="o">~</span><span class="p">(</span><span class="o">~</span><span class="mi">0U</span> <span class="o">&gt;&gt;</span> <span class="n">k</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// unsigned integer `x`, `y` (right-shift: arithmetic shift)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">x</span> <span class="o">&amp;=</span> <span class="p">(</span><span class="n">x</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>                                      <span class="n">clears</span> <span class="n">lowest</span> <span class="s">&#34;on&#34;</span> <span class="n">bit</span> <span class="n">in</span> <span class="nf">x</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span><span class="n">x</span> <span class="o">^</span> <span class="n">y</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span>                                       <span class="nb">true</span> <span class="k">if</span> <span class="n">x</span> <span class="n">and</span> <span class="n">y</span> <span class="n">have</span> <span class="n">opposite</span> <span class="n">signs</span></span></span></code></pre></td></tr></table>
</div>
</div><p>程序语言只提供最小粒度为 Byte 的操作，但是不直接提供 Bit 粒度的操作，这与字节顺序相关。假设提供以 Bit 为粒度的操作，这就需要在编程时考虑 <strong>大端/小端模式</strong>，极其繁琐。</p>
<h3 id="bitwise--logical" class="heading-element">
  <a href="#bitwise--logical" class="heading-mark"></a>bitwise &amp; logical</h3><p>位运算满足交换律，但逻辑运算并不满足交换律，因为短路机制。考虑 Linked list 中的情形:</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// list_head *head
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">head</span> <span class="o">||</span> <span class="nf">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">))</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="p">(</span><span class="nf">list_empty</span><span class="p">(</span><span class="n">head</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="n">head</span><span class="p">)</span></span></span></code></pre></td></tr></table>
</div>
</div><p>第二条语句在执行时会报错，因为 <code>list_empty</code> 要求传入的参数不为 NULL。</p>
<p>逻辑运算符 <code>!</code> 相当有效，C99 并没有完全支持 bool 类型，对于整数，它是将非零整数视为 true，零视为 false。所以如果你需要保证某一表达式的结果不仅是 true of false，还要求对应 0 or 1 时，可以使用 <code>!!(expr)</code> 来实现。</p>
<ul>
<li>C99 6.5.3.3 Unary arithmetic operators</li>
</ul>
<blockquote>
<p>The result of the logical negation operator ! is 0 if the value of its operand compares unequal to 0, 1 if the value of its operand compares equal to 0. The result has type int. The expression !E is equivalent to (0==E).</p>
</blockquote>
<p>所以 <code>!!(expr)</code> 的结果为 <code>int</code> 并且数值只有 0 或 1。</p>
<h3 id="right-shifts" class="heading-element">
  <a href="#right-shifts" class="heading-mark"></a>Right Shifts</h3><p>对于 Unsigned 或 positive sign integer 做右移运算时 <code>x &gt;&gt; n</code>，其最终结果值为 $\lfloor x / 2^n \rfloor$。</p>
<p>因为这种情况的右移操作相当于对每个 bit 表示的 power 加上 $-n$，再考虑有些 bit 表示的 power 加上 $-n$ 后会小于 0，此时直接将这些 bit 所表示的值去除即可 (因为在 integer 中 bit 的 power 最小为 0，如果 power 小于 0 表示的是小数值)，这个操作对应于向下取整。</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">    00010111 &gt;&gt; 2  (23 &gt;&gt; 4)
</span></span><span class="line"><span class="cl">-&gt;  000101.11      (5.75)
</span></span><span class="line"><span class="cl">-&gt;  000101         (5)</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="bitwise-实作" class="heading-element">
  <a href="#bitwise-%e5%ae%9e%e4%bd%9c" class="heading-mark"></a>bitwise 实作</h2><ul>
<li>Vi/Vim 为什么使用 hjkl 作为移动字符?</li>
</ul>
<blockquote>
<p>當我們回顧 1967 年 ASCII 的編碼規範，可發現前 32 個字元都是控制碼，讓人們得以透過這些特別字元來控制畫面和相關 I/O，早期鍵盤的 &ldquo;control&rdquo; 按鍵就搭配這些特別字元使用。&ldquo;control&rdquo; 組合按鍵會將原本字元的第 1 個 bit 進行 XOR，於是 H 字元對應 ASCII 編碼為 100_1000 (過去僅用 7 bit 編碼)，組合 &ldquo;control&rdquo; 後 (即 Ctrl+H) 會得到 000_1000，也就是 backspace 的編碼，這也是為何在某些程式中按下 backspace 按鍵會得到 ^H 輸出的原因。相似地，當按下 Ctrl+J 時會得到 000_1010，即 linefeed</p>
</blockquote>
<div class="details admonition note open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">where n is the bit number, and 0 is the least significant bit</div>
    </div>
  </div>
<a href="https://github.com/ccrysisa/LKI/blob/main/c-bitwise"target="_blank" rel="external nofollow noopener noreferrer">Source<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>
<h3 id="set-a-bit" class="heading-element">
  <a href="#set-a-bit" class="heading-mark"></a>Set a bit</h3><div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span> <span class="o">|=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="clear-a-bit" class="heading-element">
  <a href="#clear-a-bit" class="heading-mark"></a>Clear a bit</h3><div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="toggle-a-bit" class="heading-element">
  <a href="#toggle-a-bit" class="heading-mark"></a>Toggle a bit</h3><div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">a</span> <span class="o">^=</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="test-a-bit" class="heading-element">
  <a href="#test-a-bit" class="heading-mark"></a>Test a bit</h3><div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">bool</span> <span class="n">a</span> <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&amp;</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">n</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="the-rightleft-most-byte" class="heading-element">
  <a href="#the-rightleft-most-byte" class="heading-mark"></a>The right/left most byte</h3><div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// assuming 16 bit, 2-byte short integer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">right</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>        <span class="cm">/* right most (least significant) byte */</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">short</span> <span class="n">left</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* left  most (most  significant) byte */</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// assuming 32 bit, 4-byte int integer
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">right</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span>        <span class="cm">/* right most (least significant) byte */</span>
</span></span><span class="line"><span class="cl"><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">left</span>  <span class="o">=</span> <span class="p">(</span><span class="n">val</span> <span class="o">&gt;&gt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0xff</span><span class="p">;</span> <span class="cm">/* left  most (most  significant) byte */</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="sign-bit" class="heading-element">
  <a href="#sign-bit" class="heading-mark"></a>Sign bit</h3><div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// assuming 16 bit, 2-byte short integer, two&#39;s complement
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">sign</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x8000</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// assuming 32 bit, 4-byte int integer, two&#39;s complement
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">bool</span> <span class="n">sign</span> <span class="o">=</span> <span class="n">val</span> <span class="o">&amp;</span> <span class="mh">0x80000000</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="uses-of-bitwise-operations-or-why-to-study-bits" class="heading-element">
  <a href="#uses-of-bitwise-operations-or-why-to-study-bits" class="heading-mark"></a>Uses of Bitwise Operations or Why to Study Bits</h3><ul>
<li>Compression</li>
<li>Set operations</li>
<li>Encryption</li>
</ul>
<blockquote>
<p>最常见的就是位图 (bitmap)，常用于文件系统 (file system)，可以节省空间 (每个元素只用一个 bit 来表示)，可以很方便的进行集合操作 (通过 bitwise operator)。</p>
</blockquote>
<div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">x ^ y = (~x &amp; y) | (x &amp; ~y)</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="影像处理" class="heading-element">
  <a href="#%e5%bd%b1%e5%83%8f%e5%a4%84%e7%90%86" class="heading-mark"></a>影像处理</h2><ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> Stack Overflow: <a href="https://stackoverflow.com/questions/30237567/what-r1-r-8-8-does"target="_blank" rel="external nofollow noopener noreferrer">what (r+1 + (r &raquo; 8)) &raquo; 8 does?</a></li>
</ul>
<p>在图形引擎中将除法运算 <code>x / 255</code> 用位运算 <code>(x+1 + (x &gt;&gt; 8)) &gt;&gt; 8</code> 来实作，可以大幅度提升计算效能。</p>
<h3 id="案例分析" class="heading-element">
  <a href="#%e6%a1%88%e4%be%8b%e5%88%86%e6%9e%90" class="heading-mark"></a>案例分析</h3><p>实作程式码: <a href="https://github.com/charles620016/embedded-summer2015/tree/master/RGBAtoBW"target="_blank" rel="external nofollow noopener noreferrer">RGBAtoBW</a></p>
<p>给定每个 pixel 为 32-bit 的 RGBA 的 bitmap，提升效能的方案:</p>
<ul>
<li>建立表格加速浮点运算</li>
<li>减少位运算: 可以使用 pointer 的 offset 取代原本复杂的 bitwise operation</li>
</ul>
<div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">bwPixel</span> <span class="o">=</span> <span class="n">table</span><span class="p">[</span><span class="n">rgbPixel</span> <span class="o">&amp;</span> <span class="mh">0x00ffffff</span><span class="p">]</span> <span class="o">+</span> <span class="n">rgbPixel</span> <span class="o">&amp;</span> <span class="mh">0xff000000</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>只需对 RGB 部分建立浮点数表，因为 <code>rgbPixel &amp; 0xff00000</code> 获取的是 A，无需参与浮点运算。这样建立的表最大下标应为 0x00ffffff，所以这个表占用 $2^{24} Bytes = 16MB$，显然这个表太大了 <strong>not cache friendly</strong></p>
<div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="n">bw</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">mul_299</span><span class="p">[</span><span class="n">r</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">mul_587</span><span class="p">[</span><span class="n">g</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="kt">uint32_t</span><span class="p">)</span> <span class="n">mul_144</span><span class="p">[</span><span class="n">b</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="n">bwPixel</span> <span class="o">=</span> <span class="p">(</span><span class="n">a</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bw</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> <span class="o">+</span> <span class="p">(</span><span class="n">bw</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="n">bw</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>分别对 R, G, B 建立对应的浮点数表，则这三个表总共占用 $3 \times 2^8 Bytes &lt; 32KB$ <strong>cache friendly</strong></p>
<h2 id="案例探讨" class="heading-element">
  <a href="#%e6%a1%88%e4%be%8b%e6%8e%a2%e8%ae%a8" class="heading-mark"></a>案例探讨</h2><div class="details admonition info open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-info-circle fa-fw" aria-hidden="true"></i>信息<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><ul>
<li><a href="https://hackmd.io/@sysprog/bitwise-rotation"target="_blank" rel="external nofollow noopener noreferrer">位元旋转实作和 Linux 核心案例</a></li>
<li><a href="https://hackmd.io/@sysprog/bitwise-reverse"target="_blank" rel="external nofollow noopener noreferrer">reverse bit 原理和案例分析</a></li>
</ul>
</div>
    </div>
  </div>
<<<<<<< HEAD
<h2 id="类神经网络的-relu-极其常数时间复杂度实作" class="heading-element">
  <a href="#%e7%b1%bb%e7%a5%9e%e7%bb%8f%e7%bd%91%e7%bb%9c%e7%9a%84-relu-%e6%9e%81%e5%85%b6%e5%b8%b8%e6%95%b0%e6%97%b6%e9%97%b4%e5%a4%8d%e6%9d%82%e5%ba%a6%e5%ae%9e%e4%bd%9c" class="heading-mark"></a>类神经网络的 ReLU 极其常数时间复杂度实作</h2><ul>
<li><a href="https://hackmd.io/@sysprog/constant-time-relu"target="_blank" rel="external nofollow noopener noreferrer">原文地址<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
=======
<h2 id="类神经网络的-relu-极其常数时间复杂度实作">类神经网络的 ReLU 极其常数时间复杂度实作</h2>
<a href="https://hackmd.io/@sysprog/constant-time-relu"target="_blank" rel="external nofollow noopener noreferrer">原文地址<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>
>>>>>>> ca918a0972dc3c7d155998c5dfa36a48f678343b
<p>ReLU 定义如下:
<div class="fi-row">
$$
ReLU(x) = 
\begin{cases}
x & \text{if } x \geq 0 \newline
0 & \text{if } x \lt 0
\end{cases}
$$
</div></p>
<p>显然如果 $x$ 是 32-bit 的二补数，可以使用上面提到的 <code>x &gt;&gt; 31</code> 的技巧来实作 constant-time function:</p>
<div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int32_t</span> <span class="nf">ReLU</span><span class="p">(</span><span class="kt">int32_t</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">~</span><span class="p">(</span><span class="n">x</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">)</span> <span class="o">&amp;</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>但是在深度学习中，浮点数使用更加常见，对于浮点数进行位移运算是不允许的</p>
<ul>
<li>C99 6.5.7 Bitwise shift operators</li>
</ul>
<blockquote>
<p>Each of the operands shall have integer type.</p>
</blockquote>
<p>所以这里以 32-bit float 浮点数类型为例，利用 32-bit 二补数和 32-bit float 的 MSB 都是 sign bit，以及 C 语言类型 union 的特性</p>
<ul>
<li>C99 6.5.2.3</li>
</ul>
<blockquote>
<p>(82) If the member used to access the contents of a union object is not the same as the member last used to store a value in the object, the appropriate part of the object representation of the value is reinterpreted as an object representation in the new type as described in 6.2.6 (a process sometimes called &ldquo;type punning&rdquo;). This might be a trap representation.</p>
</blockquote>
<p>即 union 所有成员是共用一块内存的，所以访问成员时会将这块内存存储的 object 按照成员的类型进行解释。利用 <code>int32_t</code> 和 <code>float</code> 的 MSB 都是 sign bit 的特性，可以巧妙绕开对浮点数进行位移运算的限制，并且因为 union 成员内存的共用性质，保证结果的数值符合预期。</p>
<div class="highlight" id="id-15"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">ReLU</span><span class="p">(</span><span class="kt">float</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">float</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int32_t</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u</span> <span class="o">=</span> <span class="p">{.</span><span class="n">f</span> <span class="o">=</span> <span class="n">x</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">u</span><span class="p">.</span><span class="n">i</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">31</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">u</span><span class="p">.</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>同理可以完成 64-bit 浮点数的 ReLU 常数时间实作。</p>
<div class="highlight" id="id-16"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">double</span> <span class="nf">ReLU</span><span class="p">(</span><span class="kt">float</span> <span class="n">x</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">union</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kt">double</span> <span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="kt">int64_t</span> <span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="n">u</span> <span class="o">=</span> <span class="p">{.</span><span class="n">f</span> <span class="o">=</span> <span class="n">x</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="n">u</span><span class="p">.</span><span class="n">i</span> <span class="o">&amp;=</span> <span class="o">~</span><span class="p">(</span><span class="n">u</span><span class="p">.</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">63</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">u</span><span class="p">.</span><span class="n">f</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
<<<<<<< HEAD
</div><h2 id="c-语言的-bit-field" class="heading-element">
  <a href="#c-%e8%af%ad%e8%a8%80%e7%9a%84-bit-field" class="heading-mark"></a>C 语言的 bit-field</h2><div class="highlight" id="id-17"><div class="chroma">
=======
</div><h2 id="从-sqrt-2-的存在谈开平方根的快速运算">从 $\sqrt 2$ 的存在谈开平方根的快速运算</h2>
<a href="https://hackmd.io/@sysprog/sqrt"target="_blank" rel="external nofollow noopener noreferrer">原文地址<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>
<div class="details admonition note open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">这一部分需要学员对现代数学观点有一些了解，强烈推荐修台大齐震宇老师的「数学潜水艇/新生营演讲」，齐老师的这些讲座难度和广度大致相当于其它院校开设的「数学导论」一课。</div>
    </div>
  </div>
<h3 id="sqrt-2-的缘起和计算">$\sqrt 2$ 的缘起和计算</h3>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> YouTube: <a href="https://youtu.be/nAOVQEcqjSM"target="_blank" rel="external nofollow noopener noreferrer">第一次数学危机，天才是怎么被扼杀的？</a></li>
</ul>
<p>可以通过「十分逼近法」来求得近似精确的 $\sqrt 2$ 的数值，这也是「数值计算/分析」领域的一个应用，除此之外还可以使用「二分逼近法」进行求值。十分逼近法和二分逼近法的主要区别在于：十分逼近法的收敛速度比二分逼近法快很多，即会更快求得理想范围精度对应的数值。</p>
<p>在数组方法的分析中，主要关心两件事:</p>
<ul>
<li>收敛速度</li>
<li>误差分析</li>
</ul>
<p>由逼近法的过程不难看出，它们非常适合使用递归来实作:</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> YouTube: <a href="https://www.youtube.com/watch?v=PHPj0jLhcnM"target="_blank" rel="external nofollow noopener noreferrer">二分逼近法和十分逼近法求平方根</a></li>
</ul>
<h3 id="固定点和牛顿法">固定点和牛顿法</h3>
<p>固定点定理相关的证明挺有意思的 (前提是你修过数学导论这类具备现代数学观点和思维的课 &#x1f923;):</p>
<ul>
<li>存在性 (分类讨论)</li>
<li>唯一性 (反证法)</li>
<li>固定点定理 (逻辑推理)</li>
</ul>
<p>可以将求方程的根转换成求固定点的问题，然后利用收敛数列进行求解:</p>
<ul>
<li>$f(x) = 0$</li>
<li>$g(x) = p - f(x)$ and $g(p) = p$</li>
</ul>
<p>牛顿法公式:
$$
p \approx p_0 -\dfrac{f(p_0)}{f&rsquo;(p_0)}
$$</p>
<p>后面利用 $f(x) = x^2 - N = 0$ 求平方根的公式可以根据这个推导而来的，图形化解释 (切线) 也符合这个公式，自行推导:</p>
<div class="fi-row">
$$
\begin{split}
f(x) &= x^2-N = 0 \\
b &= a - \frac{f(a)}{f'(a)} = a - \frac{a^2 - N}{2a} \\
  &= \frac{a^2+N}{2a} = (a+\frac{N}{a}) \div 2
\end{split}
$$
</div>
<div class="highlight" id="id-17"><div class="chroma">
>>>>>>> ca918a0972dc3c7d155998c5dfa36a48f678343b
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">mySqrt</span><span class="p">(</span><span class="kt">int</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">&lt;</span> <span class="mi">4</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">ans</span> <span class="o">=</span> <span class="n">n</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ans</span> <span class="o">&gt;</span> <span class="mi">65535</span><span class="p">)</span>  <span class="c1">// 65535 = 2^16 - 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ans</span> <span class="o">=</span> <span class="mi">65535</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">ans</span> <span class="o">*</span> <span class="n">ans</span> <span class="o">&gt;</span> <span class="n">n</span>  <span class="o">||</span> <span class="p">(</span><span class="n">ans</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">ans</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">n</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="n">ans</span> <span class="o">=</span> <span class="p">(</span><span class="n">ans</span> <span class="o">+</span> <span class="n">n</span> <span class="o">/</span> <span class="n">ans</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">ans</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个方法的流程是，选定一个不小于目标值 $x$ 的初始值 $a$，这样依据牛顿法，$a_i,\ a_{i-1},\ &hellip;$ 会递减逼近 $x$。因为是递减的，所以防止第 12 行的乘法溢出只需要考虑初始值 $a$ 即可，这也是第 9~10 行的逻辑。那么只剩下一个问题：如何保证初始值 $a$ 不小于目标值 $x$ 呢？其实很简单，只需要根据当 $n \geq 2$ 时满足 $n=x^2 \geq 2x$，即 $\frac{n}{2} \geq x$，便可推断出 $\frac{n}{2}$ 在 $n \geq 2$ 时必然是满足大等于目标值 $x$，所以可以使用其作为初始值 $a$，这也是第 8 行的逻辑。</p>
<p>因为求解的目标精度是整数，所以第 12 行的判断是否求得平方根的逻辑是合理的 (结合中间值 $a_i$ 递减的特性思考)。</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> LeetCode <a href="https://leetcode.com/problems/sqrtx/description/"target="_blank" rel="external nofollow noopener noreferrer">69. Sqrt(x)</a></li>
</ul>
<h3 id="二进位的平方根">二进位的平方根</h3>
<p>在使用位运算计算平方根的程式码中，我们又见到了的 <code>union</code> 和 <code>do {...} whil (0)</code> 的运用。位运算求解平方根的核心在于: $n$ 可以根据 IEEE 754 表示为 $S\times1.Frac\times2^{127+E}$，这种表示法下求解平方根只需计算 $\sqrt{1.Frac}$ 和 $\sqrt{2^{(127+E)}}$ 两部分 (只考虑非负数的平方根)。虽然描述起来简单，但由于 IEEE 754 编码的复杂性，需要考虑很多情况，例如 $E$ 全 0 或全 1，因为此时对应的数值就不是之前表示的那样了 (指 $S\times1.Frac\times2^{127+E}$)，需要额外考量。</p>
<a class="lightgallery" href="https://hackmd.io/_uploads/Hymhown-9.png?size=large" data-thumbnail="https://hackmd.io/_uploads/Hymhown-9.png?size=small" data-sub-html="<h2>https://hackmd.io/_uploads/Hymhown-9.png</h2>"><img loading="lazy" src="https://hackmd.io/_uploads/Hymhown-9.png" srcset="https://hackmd.io/_uploads/Hymhown-9.png?size=small, https://hackmd.io/_uploads/Hymhown-9.png?size=medium 1.5x, https://hackmd.io/_uploads/Hymhown-9.png?size=large 2x" sizes="auto" data-title="https://hackmd.io/_uploads/Hymhown-9.png" data-alt="https://hackmd.io/_uploads/Hymhown-9.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/></a>
<ul>
<li>sign: 1 bit <code>0x80000000</code></li>
<li>exponent: 8 bits <code>0x7f800000</code></li>
<li>fraction: 23 bits <code>0x007fffff</code></li>
</ul>
<p>原文给出的程式码是用于计算 $n$ 在 IEEE 754 编码下的指数部分在平方根的结果，虽然看起来只需要除以 2 即右移 1 位即可，但其实不然，例如上面所说的考虑指数部分全为 0 的情况，所以这个程式码是精心设计用于通用计算的。</p>
<p>在原始程式码的基础上，加上对 <code>ix0</code> (对应 $1.Frac$) 使用牛顿法求平方根的逻辑，即可完成对 <code>n</code> 的平方根的求解。</p>
<p>当然这里要求和之前一样，平方根只需要整数精度即可，所以只需求出指数部分的平方根，然后通过二分法进行逼近即可满足要求 (因为剩余部分是 $1.Frac$ 并不影响平方根的整数精度，但是会导致一定误差，所以需要对指数部分进行二分逼近求值)。</p>
<blockquote>
<p>先求出整數 <code>n</code> 開根號後結果的 $1.FRACTION \times 2^{EXPONENT}$ 的 $EXPONENT$ 部份，則我們知道 <code>n</code> 開根號後的結果 $k$ 應滿足 $2^{EXPONENT} \leq k &lt; 2^{EXPONENT+1}$，因此後續可以用二分搜尋法找出結果。</p>
</blockquote>
<div class="details admonition note open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">这段程式码可以再一次看到 枚举 <code>union</code> 和 宏 <code>do {...} while (0)</code> 的应用之外，主要是根据 IEEE 754 编码规范进行求解，所以需要对浮点数的编码格式有一定认知，可以参考阅读: <a href="https://hackmd.io/@sysprog/c-floating-point"target="_blank" rel="external nofollow noopener noreferrer">你所不知道的 C 语言: 浮点数运算</a>。</div>
    </div>
  </div>
<h3 id="fast-inverse-square-root-平方根倒数">Fast Inverse Square Root (平方根倒数)</h3>
<p>下面的录影解说了程式码中的黑魔法 <code>0x5f3759df</code> 的原理，本质也是牛顿法，只不过是选择一个接近目标值的初始值，从而只需要一次牛顿法即可求解出相对高精度的目标平方根，里面还运用到了对数这类的技巧:</p>
<ul>
<li><i class="fa-regular fa-check-square fa-fw" aria-hidden="true"></i> YouTube: <a href="https://www.youtube.com/watch?v=g1r3iLejTw0"target="_blank" rel="external nofollow noopener noreferrer">没有显卡的年代，这群程序员用4行代码优化游戏</a></li>
</ul>
<p>使用 IEEE 754 表示任意单精度浮点数为: $x = (1 + \frac{M}{2^{23}}) \times 2^{E-127}$，则该 $x$ 对应的对数为</p>
<div class="fi-row">
$$
\begin{split}
\log x &= \log{(1 + \frac{M}{2^{23}}) \times 2^{E-127}} \\
       &= \log{(1 + \frac{M}{2^{23}})} + \log{2^{E-127}} \\
       &= \frac{M}{2^{23}} + E - 127 \\
       & = \frac{1}{2^{23}}(2^{23} \times E + M) - 127 \\
       & = \frac{1}{2^{23}}X - 127
\end{split}
$$
</div>
<p>注意上面处理 $\log{(1 + \frac{M}{2^{23}})}$ 部分时使用近似函数 $f(x) = x$ 代替了，当然会有一些误差，后面会提。最后的 $2^{23} \times E + M$ 部分只和浮点数的表示域相关，并且 <strong>这个运算的结果值和以二补数编码解释浮点数的数值相同</strong> (参考上面的 IEEE 754 浮点数结构图，以及二补数的数值计算规则)，我们用一个大写标识 $X$ 来标记其只与浮点数编码相关，并且对应二补数编码下的数值。</p>
<p>推导出对数的通用公式后，接下来就可以推导平方根倒数了，即求得对应数值的 $-\frac{1}{2}$ 次方。假设 $a$ 是 $y$ 的平方根倒数，则有等式:</p>
<div class="fi-row">
$$
\begin{split}
\log a &= \log{y^{-\frac{1}{2}}} \\
\log a &= -\frac{1}{2} \log y \\
-\frac{1}{2^{23}}A - 127 &= -\frac{1}{2}(-\frac{1}{2^{23}} - 127) \\
A &= 381 \times 2^{22} - \frac{1}{2} Y
\end{split}
$$
</div>
<p>中间将数值由浮点数转换成二补数编码表示，并求得最终的浮点数表示为 $381 \times 2^{22} - \frac{1}{2} Y$，其中的 $381 \times 2^{22}$ 对应的 16 进制恰好为 <code>0x5f400000</code>，这已经很接近我们看到的魔数了，但还有一点偏差。
这是因为在计算 $\log{(1 + \frac{M}{2^{23}})}$ 时直接使用 $f(x) = x$ 导致的总体误差还是较大，但是只需要将其稍微往 $y$ 轴正方向偏移一些就可以减少总体误差 (机器学习中常用的技巧 &#x1f923;)，所以使用 $\frac{M}{2^{23}} + \lambda$ 代替原先的 $\frac{M}{2^{23}}$ ($\lambda$ 为修正的误差且 $\lambda &gt; 0$)，这会导致最终结果的 381 发生稍微一些变化 (因为二补数编码解释浮点数格式部分 $X$ 不能动，只能影响常数 $127$，而常数 $127$ 又直接影响最终结果的 $381$ 这类常数部分)，进而产生魔数 <code>0x5f3759df</code>。</p>
<div class="highlight" id="id-18"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">float</span> <span class="nf">InvSqrt</span><span class="p">(</span><span class="kt">float</span> <span class="n">x</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>  
</span></span><span class="line"><span class="cl">    <span class="kt">float</span> <span class="n">xhalf</span> <span class="o">=</span> <span class="mf">0.5f</span> <span class="o">*</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">i</span> <span class="o">=</span> <span class="mh">0x5f3759df</span> <span class="o">-</span> <span class="p">(</span><span class="n">i</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">float</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span> <span class="o">*</span> <span class="p">(</span><span class="mf">1.5f</span> <span class="o">-</span> <span class="n">xhalf</span> <span class="o">*</span> <span class="n">x</span> <span class="o">*</span> <span class="n">x</span><span class="p">);</span> <span class="c1">// only once newton iteration
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">x</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="c-语言的-bit-field">C 语言的 bit-field</h2>
<a href="https://hackmd.io/@sysprog/c-bitfield"target="_blank" rel="external nofollow noopener noreferrer">原文地址<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>
<div class="highlight" id="id-19"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdbool.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp">#include</span> <span class="cpf">&lt;stdio.h&gt;</span><span class="cp">
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="kt">bool</span> <span class="nf">is_one</span><span class="p">(</span><span class="kt">int</span> <span class="n">i</span><span class="p">)</span> <span class="p">{</span> <span class="k">return</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="p">{</span> <span class="kt">signed</span> <span class="kt">int</span> <span class="nl">a</span> <span class="p">:</span> <span class="mi">1</span><span class="p">;</span> <span class="p">}</span> <span class="n">obj</span> <span class="o">=</span> <span class="p">{</span> <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="nf">puts</span><span class="p">(</span><span class="nf">is_one</span><span class="p">(</span><span class="n">obj</span><span class="p">.</span><span class="n">a</span><span class="p">)</span> <span class="o">?</span> <span class="s">&#34;one&#34;</span> <span class="o">:</span> <span class="s">&#34;not one&#34;</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>C99 6.7.2.1 Structure and union specifiers</li>
</ul>
<blockquote>
<p>A bit-field shall have a type that is a qualified or unqualified version of <code>_Bool</code>, <code>signed int</code>, <code>unsigned int</code>, or some other implementation-defined type.</p>
</blockquote>
<blockquote>
<p>A bit-field is interpreted as a signed or unsigned integer type consisting of the specified number of bits.</p>
</blockquote>
<p>将 <code>a</code> 这个 1-bit 的位域 (bit-field) 声明成 <code>signed int</code>，即将 <code>a</code> 视为一个 1-bit 的二补数，所以 <code>a</code> 的数值只有 0，-1。接下来将 1 赋值给 <code>a</code> 会使得 <code>a</code> 的数值为 -1，然后将 <code>a</code> 作为参数传入 <code>is_one</code> 时会进行符号扩展 (sign extension) 为 32-bit 的二补数 (假设编译器会将 <code>int</code> 视为 signed int)，所以数值仍然为 -1。因此最终会输出 &ldquo;not one&rdquo;.</p>
<<<<<<< HEAD
<h3 id="linux-核心-build_bug_on_zero" class="heading-element">
  <a href="#linux-%e6%a0%b8%e5%bf%83-build_bug_on_zero" class="heading-mark"></a>Linux 核心: BUILD_BUG_ON_ZERO()</h3><div class="highlight" id="id-18"><div class="chroma">
=======
<h3 id="linux-核心-build_bug_on_zero">Linux 核心: BUILD_BUG_ON_ZERO()</h3>
<div class="highlight" id="id-20"><div class="chroma">
>>>>>>> ca918a0972dc3c7d155998c5dfa36a48f678343b
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm"> * Force a compilation error if condition is true, but also produce a
</span></span></span><span class="line"><span class="cl"><span class="cm"> * result (of value 0 and type size_t), so the expression can be used
</span></span></span><span class="line"><span class="cl"><span class="cm"> * e.g. in a structure initializer (or where-ever else comma expressions
</span></span></span><span class="line"><span class="cl"><span class="cm"> * aren&#39;t permitted).
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="cp">#define BUILD_BUG_ON_ZERO(e) (sizeof(struct { int:(-!!(e)); }))</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个宏运用了上面所说的 <code>!!</code> 技巧将 <code>-!!(e)</code> 的数值限定在 0 和 -1。</p>
<p>这个宏的功能是:</p>
<ul>
<li>
<p>当 <code>e</code> 为 true 时，<code>-!!(e)</code> 为 -1，即 bit-field 的 size 为负数</p>
</li>
<li>
<p>当 <code>e</code> 为 false 时，<code>-!!(e)</code> 为 0，即 bit-field 的 size 为 0</p>
</li>
<li>
<p>C99 6.7.2.1 Structure and union specifiers</p>
</li>
</ul>
<blockquote>
<p>The expression that specifies the width of a bit-field shall be an <strong>integer constant expression with a nonnegative value</strong> that does not exceed the width of an object of the type that would be specified were the colon and expression omitted. If the value is zero, the declaration shall have no declarator.</p>
</blockquote>
<blockquote>
<p>A bit-field declaration with no declarator, but only a colon and a width, indicates an unnamed bit-field. As a special case, a bit-field structure member with a width of 0 indicates that no further bit-field is to be packed into the unit in which the previous bitfield, if any, was placed.</p>
</blockquote>
<blockquote>
<p>(108) An unnamed bit-field structure member is useful for padding to conform to externally imposed layouts.</p>
</blockquote>
<p>根据上面 C99 标准的说明，当 bit-feild 的 size 为负数时会编译失败 (只允许 integer constant expression with a nonnegative value)，当 bit-field 为 0 时，会进行 alignment (以之前的 bit-field 成员所在的 unit 为单位)。</p>
<div class="highlight" id="id-21"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">struct</span> <span class="n">foo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nl">a</span> <span class="p">:</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nl">b</span> <span class="p">:</span> <span class="mi">2</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="o">:</span> <span class="mi">0</span><span class="p">;</span> <span class="cm">/* Force alignment to next boundary */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nl">c</span> <span class="p">:</span> <span class="mi">4</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="nl">d</span> <span class="p">:</span> <span class="mi">3</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mh">0xFFFF</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">struct</span> <span class="n">foo</span> <span class="o">*</span><span class="n">f</span> <span class="o">=</span> <span class="p">(</span><span class="k">struct</span> <span class="n">foo</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">i</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="nf">printf</span><span class="p">(</span><span class="s">&#34;a=%d</span><span class="se">\n</span><span class="s">b=%d</span><span class="se">\n</span><span class="s">c=%d</span><span class="se">\n</span><span class="s">d=%d</span><span class="se">\n</span><span class="s">&#34;</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">a</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">b</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">c</span><span class="p">,</span> <span class="n">f</span><span class="o">-&gt;</span><span class="n">d</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这里使用了 size 为 0 的 bit-field，其内存布局如下:</p>
<div class="highlight" id="id-22"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">i = 1111 1111 1111 1111
</span></span><span class="line"><span class="cl">X stand for unknown value
</span></span><span class="line"><span class="cl">assume little endian
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">padding &amp; start from here
</span></span><span class="line"><span class="cl">        ↓
</span></span><span class="line"><span class="cl">        1111 1111 1111 1111XXXX XXXX XXXX XXXX
</span></span><span class="line"><span class="cl">                     b baaa           ddd cccc
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        |←  int 32 bits  →||←  int 32 bits  →|</span></span></code></pre></td></tr></table>
</div>
</div><p>zero size bit-field 使得这里在 <code>a</code>, <code>b</code> 和 <code>c</code>, <code>d</code> 之间进行 <code>sizeof(int)</code> 的 alignment，所以 <code>c</code>, <code>d</code> 位于 <code>i</code> 这个 object 范围之外，因此 <code>c</code>, <code>d</code> 每次执行时的数值是不确定的，当然这也依赖于编译器，可以使用 gcc 和 clang 进行测试 &#x1f923;</p>
<ul>
<li>C11 3.14 1 memory location</li>
</ul>
<blockquote>
<p>(<em>NOTE 2</em>) A bit-field and an adjacent non-bit-field member are in separate memory locations. The same
applies to two bit-fields, if one is declared inside a nested structure declaration and the other is not, or if the
two are separated by a zero-length bit-field declaration, or if they are separated by a non-bit-field member
declaration. It is not safe to concurrently update two non-atomic bit-fields in the same structure if all
members declared between them are also (non-zero-length) bit-fields, no matter what the sizes of those
intervening bit-fields happen to be.</p>
</blockquote>
<p>所以 <code>BUILD_BUG_ON_ZERO</code> 宏相当于编译时期的 <code>assert</code>，因为 <code>assert</code> 是在执行时期才会触发的，对于 Linux 核心来说代价太大了 (想象一下核心运行着突然触发一个 <code>assert</code> 导致当掉 &#x1f923;)，所以采用了 <code>BUILD_BUG_ON_ZERO</code> 宏在编译时期就进行检查 (莫名有一种 Rust 的风格 &#x1f923;)</p>
<p>对于 <code>BUILD_BUG_ON_ZERO</code> 这个宏，C11 提供了 <a href="https://en.cppreference.com/w/c/language/_Static_assert"target="_blank" rel="external nofollow noopener noreferrer">_Static_assert</a> 语法达到相同效果，但是 Linux kernel 自己维护了一套编译工具链 (这个工具链 gcc 版本可能还没接纳 C11 &#x1f923;)，所以还是使用自己编写的 <code>BUILD_BUG_ON_ZERO</code> 宏。</p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2024-03-24 13:40:19">更新于 2024-03-24&nbsp;</span>
      </div></div><div class="post-info-line">
        <div class="post-info-md"><span><a href="/posts/c-bitwise/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
        <div class="post-info-share">
          <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://ccrysisa.github.io/posts/c-bitwise/" data-title="你所不知道的 C 语言: bitwise 操作" data-hashtags="Sysprog,C,Bitwise"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://ccrysisa.github.io/posts/c-bitwise/" data-hashtag="Sysprog"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://ccrysisa.github.io/posts/c-bitwise/" data-title="你所不知道的 C 语言: bitwise 操作" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://ccrysisa.github.io/posts/c-bitwise/" data-title="你所不知道的 C 语言: bitwise 操作"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://ccrysisa.github.io/posts/c-bitwise/" data-title="你所不知道的 C 语言: bitwise 操作"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://ccrysisa.github.io/posts/c-bitwise/" data-title="你所不知道的 C 语言: bitwise 操作" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://ccrysisa.github.io/posts/c-bitwise/" data-title="你所不知道的 C 语言: bitwise 操作" data-description=""><i class="fa-brands fa-blogger fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://ccrysisa.github.io/posts/c-bitwise/" data-title="你所不知道的 C 语言: bitwise 操作"><i class="fa-brands fa-evernote fa-fw" aria-hidden="true"></i></a>
  </span>
        </div>
      </div></div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href="/tags/sysprog/" class="post-tag" title="标签 - Sysprog">Sysprog</a><a href="/tags/c/" class="post-tag" title="标签 - C">C</a><a href="/tags/bitwise/" class="post-tag" title="标签 - Bitwise">Bitwise</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/smart-pointers-and-interior-mutability/" class="post-nav-item" rel="prev" title="Crust of Rust: Smart Pointers and Interior Mutability"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Crust of Rust: Smart Pointers and Interior Mutability</a>
      <a href="/posts/c-memory/" class="post-nav-item" rel="next" title="你所不知道的 C 语言: 内存管理、对齐及硬体特性">你所不知道的 C 语言: 内存管理、对齐及硬体特性<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
<<<<<<< HEAD
</article>

  <aside class="toc" id="toc-auto" aria-label="目录"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.121.1"><img class="hugo-icon" src="/images/hugo.min.svg" alt="Hugo logo" /> Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.3.2-RC"><img class="fixit-icon" src="/images/fixit.min.svg" alt="FixIt logo" /> FixIt</a>
=======
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.121.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.18-lts.5"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
>>>>>>> ca918a0972dc3c7d155998c5dfa36a48f678343b
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/ccrysisa"target="_blank" rel="external nofollow noopener noreferrer">ccrysisa</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":20},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50}};</script><script src="/js/theme.min.js" defer></script></body>
</html>

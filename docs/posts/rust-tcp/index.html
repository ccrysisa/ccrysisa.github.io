<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>Implementing TCP/IP in Rust - KZn&#39;s Blog</title><meta name="author" content="ccrysisa">
<meta name="author-link" content="https://github.com/ccrysisa">
<meta name="description" content="
In this stream, we started implementing the ubiquitous TCP protocol that underlies much of the traffic on the internet! In particular, we followed RFC 793 — https://tools.ietf.org/html/rfc793 — which describes the original protocol, with the goal of being able to set up and tear down a connection with a &ldquo;real&rdquo; TCP stack at the other end (netcat in particular). We&rsquo;re writing it using a user-space networking interface (see https://www.kernel.org/doc/Documentation/networking/tuntap.txt and the Rust bindings at https://docs.rs/tun-tap/).
" /><meta name="keywords" content='Rust, TCP, Network' /><meta itemprop="name" content="Implementing TCP/IP in Rust">
<meta itemprop="description" content="
In this stream, we started implementing the ubiquitous TCP protocol that underlies much of the traffic on the internet! In particular, we followed RFC 793 — https://tools.ietf.org/html/rfc793 — which describes the original protocol, with the goal of being able to set up and tear down a connection with a &ldquo;real&rdquo; TCP stack at the other end (netcat in particular). We&rsquo;re writing it using a user-space networking interface (see https://www.kernel.org/doc/Documentation/networking/tuntap.txt and the Rust bindings at https://docs.rs/tun-tap/).
"><meta itemprop="datePublished" content="2024-02-17T19:01:53+08:00" />
<meta itemprop="dateModified" content="2024-02-19T14:19:25+08:00" />
<meta itemprop="wordCount" content="1469"><meta itemprop="image" content="https://ccrysisa.github.io/logo.png" />
<meta itemprop="keywords" content="Rust,TCP,Network," /><meta property="og:title" content="Implementing TCP/IP in Rust" />
<meta property="og:description" content="
In this stream, we started implementing the ubiquitous TCP protocol that underlies much of the traffic on the internet! In particular, we followed RFC 793 — https://tools.ietf.org/html/rfc793 — which describes the original protocol, with the goal of being able to set up and tear down a connection with a &ldquo;real&rdquo; TCP stack at the other end (netcat in particular). We&rsquo;re writing it using a user-space networking interface (see https://www.kernel.org/doc/Documentation/networking/tuntap.txt and the Rust bindings at https://docs.rs/tun-tap/).
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ccrysisa.github.io/posts/rust-tcp/" /><meta property="og:image" content="https://ccrysisa.github.io/logo.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-02-17T19:01:53+08:00" />
<meta property="article:modified_time" content="2024-02-19T14:19:25+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://ccrysisa.github.io/logo.png" /><meta name="twitter:title" content="Implementing TCP/IP in Rust"/>
<meta name="twitter:description" content="
In this stream, we started implementing the ubiquitous TCP protocol that underlies much of the traffic on the internet! In particular, we followed RFC 793 — https://tools.ietf.org/html/rfc793 — which describes the original protocol, with the goal of being able to set up and tear down a connection with a &ldquo;real&rdquo; TCP stack at the other end (netcat in particular). We&rsquo;re writing it using a user-space networking interface (see https://www.kernel.org/doc/Documentation/networking/tuntap.txt and the Rust bindings at https://docs.rs/tun-tap/).
"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://ccrysisa.github.io/posts/rust-tcp/" /><link rel="prev" href="https://ccrysisa.github.io/posts/linux-quiz1/" /><link rel="next" href="https://ccrysisa.github.io/posts/linux2023-lab0/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "Implementing TCP/IP in Rust",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/ccrysisa.github.io\/posts\/rust-tcp\/"
    },"genre": "posts","keywords": "Rust, TCP, Network","wordcount":  1469 ,
    "url": "https:\/\/ccrysisa.github.io\/posts\/rust-tcp\/","datePublished": "2024-02-17T19:01:53+08:00","dateModified": "2024-02-19T14:19:25+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "ccrysisa"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="KZn&#39;s Blog"><img loading="lazy" src="/fixit.min.svg" data-title="KZn&#39;s Blog" data-alt="KZn&#39;s Blog" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">KZn&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="KZn&#39;s Blog"><img loading="lazy" src="/fixit.min.svg" data-title="/fixit.min.svg" data-alt="/fixit.min.svg" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">KZn&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><span>Implementing TCP/IP in Rust</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/ccrysisa" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img loading="lazy" src="https://avatars.githubusercontent.com/u/133117003?s=400&amp;v=4" data-title="ccrysisa" data-alt="ccrysisa" class="avatar" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;ccrysisa</a></span>
          <span class="post-category">收录于 <a href="/categories/rust/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Rust</a></span></div>
      <div class="post-meta-line"><span title="发布于 2024-02-17 19:01:53"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2024-02-17">2024-02-17</time></span>&nbsp;<span title="更新于 2024-02-19 14:19:25"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2024-02-19">2024-02-19</time></span>&nbsp;<span title="1469 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 1500 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 3 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#影片注解-part-1">影片注解 Part 1</a>
      <ul>
        <li><a href="#raw-socket-vs-tuntap-device">Raw socket vs TUN/TAP device</a></li>
        <li><a href="#setcap">setcap</a></li>
        <li><a href="#endianness">Endianness</a></li>
        <li><a href="#ip">IP</a></li>
        <li><a href="#tcp">TCP</a></li>
      </ul>
    </li>
    <li><a href="#documentations">Documentations</a>
      <ul>
        <li><a href="#crate-stdhttpsdocrust-langorgstdindexhtml">Crate <a href="https://doc.rust-lang.org/std/index.html">std</a></a></li>
        <li><a href="#crate-tun_taphttpsdocsrstun-taplatesttun_tap">Crate <a href="https://docs.rs/tun-tap/latest/tun_tap/">tun_tap</a></a></li>
        <li><a href="#crate-etherparsehttpsdocsrsetherparselatestetherparseindexhtml">Crate <a href="https://docs.rs/etherparse/latest/etherparse/index.html">etherparse</a></a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><blockquote>
<p>In this stream, we started implementing the ubiquitous TCP protocol that underlies much of the traffic on the internet! In particular, we followed RFC 793 — <a href="https://tools.ietf.org/html/rfc793"target="_blank" rel="external nofollow noopener noreferrer">https://tools.ietf.org/html/rfc793</a> — which describes the original protocol, with the goal of being able to set up and tear down a connection with a &ldquo;real&rdquo; TCP stack at the other end (netcat in particular). We&rsquo;re writing it using a user-space networking interface (see <a href="https://www.kernel.org/doc/Documentation/networking/tuntap.txt"target="_blank" rel="external nofollow noopener noreferrer">https://www.kernel.org/doc/Documentation/networking/tuntap.txt</a> and the Rust bindings at <a href="https://docs.rs/tun-tap/%29"target="_blank" rel="external nofollow noopener noreferrer">https://docs.rs/tun-tap/)</a>.</p>
</blockquote>
<p>整理自 John Gjengset 的影片:</p>
<ul>
<li><a href="https://www.youtube.com/watch?v=bzja9fQWzdA"target="_blank" rel="external nofollow noopener noreferrer">Part 1</a></li>
</ul>
<h2 id="影片注解-part-1">影片注解 Part 1</h2>
<h3 id="raw-socket-vs-tuntap-device">Raw socket vs TUN/TAP device</h3>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Network_socket#Raw_sockets#Types"target="_blank" rel="external nofollow noopener noreferrer">Raw sockets</a> [Wikipedia]</li>
<li><a href="https://en.wikipedia.org/wiki/TUN/TAP"target="_blank" rel="external nofollow noopener noreferrer">TUN/TAP</a> [Wikipedia]</li>
<li><a href="https://stackoverflow.com/questions/41343802/raw-socket-vs-tun-device"target="_blank" rel="external nofollow noopener noreferrer">Raw socket vs TUN device</a> [Stack Overflow]</li>
<li><a href="https://www.kernel.org/doc/Documentation/networking/tuntap.txt"target="_blank" rel="external nofollow noopener noreferrer">Universal TUN/TAP device driver</a> [Linux kernel documentation]</li>
</ul>
<p>Raw socket:</p>
<ul>
<li>Internet &ndash;&gt; NIC &ndash;&gt; kernel &ndash;&gt; user space</li>
<li>Internet &lt;&ndash; NIC &lt;&ndash; kernel &lt;&ndash; user space</li>
</ul>
<blockquote>
<p>Host interact with other hosts in Internet.</p>
</blockquote>
<p>TUN/TAP device:</p>
<ul>
<li>kernel &ndash;&gt; | TUN/TAP | &ndash;&gt; user space</li>
<li>kernel &lt;&ndash; | TUN/TAP | &lt;&ndash; user space</li>
</ul>
<blockquote>
<p>Kernel interact with programs in user space in the same host.</p>
</blockquote>
<a class="lightgallery" href="https://upload.wikimedia.org/wikipedia/commons/a/af/Tun-tap-osilayers-diagram.png?size=large" data-thumbnail="https://upload.wikimedia.org/wikipedia/commons/a/af/Tun-tap-osilayers-diagram.png?size=small" data-sub-html="<h2>https://upload.wikimedia.org/wikipedia/commons/a/af/Tun-tap-osilayers-diagram.png</h2>"><img loading="lazy" src="https://upload.wikimedia.org/wikipedia/commons/a/af/Tun-tap-osilayers-diagram.png" srcset="https://upload.wikimedia.org/wikipedia/commons/a/af/Tun-tap-osilayers-diagram.png?size=small, https://upload.wikimedia.org/wikipedia/commons/a/af/Tun-tap-osilayers-diagram.png?size=medium 1.5x, https://upload.wikimedia.org/wikipedia/commons/a/af/Tun-tap-osilayers-diagram.png?size=large 2x" sizes="auto" data-title="https://upload.wikimedia.org/wikipedia/commons/a/af/Tun-tap-osilayers-diagram.png" data-alt="https://upload.wikimedia.org/wikipedia/commons/a/af/Tun-tap-osilayers-diagram.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/></a>
<blockquote>
<p>和其他物理网卡一样，用户进程创建的 TUN/TAP 设备仍然是被 kernel 所拥有的 (kernel 可以使用设备进行发送/接收)，只不过用户进程也可以像操作 <strong>管道 (pipe)</strong> 那样，操作所创建的 TUN/TAP 设备 (可以使用该设备进行发送/接收)，从而与 kernel 的物理网卡进行通信。</p>
</blockquote>
<p>Universal TUN/TAP device driver [Linux kernel documentation]</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">3.2 Frame format:   
</span></span><span class="line"><span class="cl">If flag IFF_NO_PI is not set each frame format is:   
</span></span><span class="line"><span class="cl">    Flags [2 bytes]   
</span></span><span class="line"><span class="cl">    Proto [2 bytes]   
</span></span><span class="line"><span class="cl">    Raw protocol(IP, IPv6, etc) frame.   </span></span></code></pre></td></tr></table>
</div>
</div><p>通过 TUN/TAP 设备接收的封包，会拥有 Flags 和 Proto 这两个字段 (共 4 个字节，这也是 iface 的 <code>without_packet_info</code> 和 <code>recv</code> 方法所描述的 prepended packet info)，然后才是原始协议的 frame。其中的 Proto 字段是 <a href="https://en.wikipedia.org/wiki/EtherType"target="_blank" rel="external nofollow noopener noreferrer">EtherType</a> [Wikipedia]，可以根据里面的 values 来判断接受封包的协议类型 (0x0800 表示 IPv4，0x86DD 表示 IPv6)。</p>
<h3 id="setcap">setcap</h3>
<ul>
<li><a href="https://man7.org/linux/man-pages/man8/setcap.8.html"target="_blank" rel="external nofollow noopener noreferrer">setcap</a> [Linux manual page]</li>
<li><a href="https://man7.org/linux/man-pages/man3/cap_from_text.3.html"target="_blank" rel="external nofollow noopener noreferrer">cap_from_text</a> [Linux manual page]</li>
</ul>
<p>因为 TUN/TAP 是由 kernel 提供的，所以需要赋予我们项目的可执行文件权限，使它能访问我们创建的 TUN/TAP 设备 (为了简单起见，下面只列出 release 版本的方法，debug 版本的方法类似)。</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 编译</span>
</span></span><span class="line"><span class="cl">$ cargo build --release
</span></span><span class="line"><span class="cl"><span class="c1"># 设置文件权限</span>
</span></span><span class="line"><span class="cl">$ sudo setcap <span class="nv">cap_net_admin</span><span class="o">=</span>eip target/release/trust
</span></span><span class="line"><span class="cl"><span class="c1"># 运行</span>
</span></span><span class="line"><span class="cl">$ cargo run --release</span></span></code></pre></td></tr></table>
</div>
</div><p>在另一终端输入命令 <code>ip addr</code> 就可以看到此时会多出一个名为 <code>tun0</code> 的设备，这正是我们创建的 TUN 设备。</p>
<ul>
<li><a href="https://man7.org/linux/man-pages/man8/ip-address.8.html"target="_blank" rel="external nofollow noopener noreferrer">ip-address</a> [Linux manual page]</li>
<li><a href="https://man7.org/linux/man-pages/man8/ip-link.8.html"target="_blank" rel="external nofollow noopener noreferrer">ip-link</a> [Linux manual page]</li>
</ul>
<p>在另一个终端中输入:</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="c1"># 列出当前所有的网络设备</span>
</span></span><span class="line"><span class="cl">$ ip addr
</span></span><span class="line"><span class="cl"><span class="c1"># 配置设备 tun0 的 IP 地址</span>
</span></span><span class="line"><span class="cl">$ sudo ip addr add 192.168.0.1/24 dev tun0
</span></span><span class="line"><span class="cl"><span class="c1"># 启动设备 tun0</span>
</span></span><span class="line"><span class="cl">$ sudo ip link <span class="nb">set</span> up dev tun0</span></span></code></pre></td></tr></table>
</div>
</div><p>每次编译后都需要执行一遍这个流程 (因为重新编译生成的可执行文件需要重新设置权限)，我们将这些流程的逻辑写成一个脚本 <a href="">run.sh</a>。这个脚本为了输出的美观性增加了额外逻辑，例如将 trust 放在后台执行，将脚本设置为等待 trust 执行完成后才结束执行。</p>
<h3 id="endianness">Endianness</h3>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Endianness"target="_blank" rel="external nofollow noopener noreferrer">Endianness</a> [Wikipedia]</li>
<li><a href="https://stackoverflow.com/questions/13514614/why-is-network-byte-order-defined-to-be-big-endian"target="_blank" rel="external nofollow noopener noreferrer">Why is network-byte-order defined to be big-endian?</a> [Stack Overflow]</li>
</ul>
<p>Rust 提供了 Trait <a href="https://doc.rust-lang.org/std/simd/trait.ToBytes.html#"target="_blank" rel="external nofollow noopener noreferrer">std::simd::ToBytes</a> 用于大小端字节序之间的相互转换，方法 <code>from_be_bytes</code> 是将大端字节序的一系列字节转换成对应表示的数值。</p>
<h3 id="ip">IP</h3>
<p>因为 TUN 只是在 Network layer 的虚拟设备 (TAP 则是 Data link layer 层)，所以需要手动解析 IP 封包。</p>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc791"target="_blank" rel="external nofollow noopener noreferrer">RFC 791</a> 3.1. Internet Header Format</li>
<li><a href="https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers"target="_blank" rel="external nofollow noopener noreferrer">List of IP protocol numbers</a> [Wikipedia]</li>
</ul>
<p>可以按照上面的格式来解析封包头，也可以引入 Crate <a href="https://docs.rs/etherparse/latest/etherparse/index.html"target="_blank" rel="external nofollow noopener noreferrer">etherparse</a> 来解析 IP 封包头。</p>
<p>ping 命令使用的是 Network layer 上的 ICMP 协议，可以用于测试 TUN 是否成功配置并能接收封包。</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ ping -I tun0 192.168.0.2</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><a href="https://en.wikipedia.org/wiki/Ping_%28networking_utility%29"target="_blank" rel="external nofollow noopener noreferrer">ping (networking utility)</a> [Wikipedia]</li>
<li><a href="https://linux.die.net/man/8/ping"target="_blank" rel="external nofollow noopener noreferrer">ping</a> [Linux man page]</li>
</ul>
<p>nc 命令用于发送 TCP 封包</p>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ nc 192.168.0.2 <span class="m">80</span></span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><a href="https://linux.die.net/man/1/nc"target="_blank" rel="external nofollow noopener noreferrer">nc</a> [Linux man page]</li>
</ul>
<div class="details admonition note open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">ping, nc 这些命令使用的都是 kernel 的协议栈来实现，所以在创建虚拟设备 tun0 之后，使用以上 ping, nc 命令表示 kernel 发送相应的 ICMP, TCP 封包给创建 tun0 的进程 (process)。</div>
    </div>
  </div>
<p>可以使用 tshark (Terminal Wireshark) 工具来抓包，配合 ping,nc 命令可以分析 tun0 的封包传送。</p>
<div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl">$ sudo apt install tshark
</span></span><span class="line"><span class="cl">$ sudo tshark -i tun0</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li><a href="https://en.wikipedia.org/wiki/Wireshark"target="_blank" rel="external nofollow noopener noreferrer">Wireshark</a> [Wikipedia]</li>
<li><a href="https://www.wireshark.org/docs/man-pages/tshark.html"target="_blank" rel="external nofollow noopener noreferrer">tshark</a> [Manual Page]</li>
</ul>
<h3 id="tcp">TCP</h3>
<p>[RFC 793] 3.2 Terminology</p>
<blockquote>
<p>The state diagram in figure 6 illustrates only state changes, together
with the causing events and resulting actions, but addresses neither
error conditions nor actions which are not connected with state
changes.</p>
</blockquote>
<p>这里面提到的 Figure 6. TCP Connection State Diagram 在其中我们可以看到 TCP 的状态转换，非常有利于直观理解 TCP 建立连接时的三次握手过程。</p>
<div class="details admonition warning open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-exclamation-triangle fa-fw" aria-hidden="true"></i>警告<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">NOTE BENE:  this diagram is only a summary and must not be taken as the total specification.</div>
    </div>
  </div>
<p><a href="https://en.wikipedia.org/wiki/Time_to_live#:~:text=In%20the%20IPv4%20header%2C%20TTL,recommended%20initial%20value%20is%2064."target="_blank" rel="external nofollow noopener noreferrer">Time to live</a> [Wikipedia]</p>
<blockquote>
<p>In the IPv4 header, TTL is the 9th octet of 20. In the IPv6 header, it is the 8th octet of 40. The maximum TTL value is 255, the maximum value of a single octet. A recommended initial value is 64.</p>
</blockquote>
<h2 id="documentations">Documentations</h2>
<p>这里列举视频中一些概念相关的 documentation</p>
<blockquote>
<p>学习的一手资料是官方文档，请务必自主学会阅读规格书之类的资料</p>
</blockquote>
<h3 id="crate-stdhttpsdocrust-langorgstdindexhtml">Crate <a href="https://doc.rust-lang.org/std/index.html"target="_blank" rel="external nofollow noopener noreferrer">std</a></h3>
<ul>
<li>
<p>Module <a href="https://doc.rust-lang.org/std/io/index.html"target="_blank" rel="external nofollow noopener noreferrer">std::io</a></p>
<ul>
<li>Type Alias <a href="https://doc.rust-lang.org/std/io/type.Result.html"target="_blank" rel="external nofollow noopener noreferrer">std::io::Result</a></li>
</ul>
</li>
<li>
<p>Module <a href="">std::collections::hash_map</a></p>
<ul>
<li>method <a href="https://doc.rust-lang.org/std/collections/hash_map/struct.HashMap.html#method.entry"target="_blank" rel="external nofollow noopener noreferrer">std::collections::hash_map::HashMap::entry</a></li>
<li>method <a href="https://doc.rust-lang.org/std/collections/hash_map/enum.Entry.html#method.or_default"target="_blank" rel="external nofollow noopener noreferrer">std::collections::hash_map::Entry::or_default</a></li>
</ul>
</li>
<li>
<p>Trait <a href="https://doc.rust-lang.org/std/default/trait.Default.html"target="_blank" rel="external nofollow noopener noreferrer">std::default::Default</a></p>
</li>
<li>
<p>Module <a href="https://doc.rust-lang.org/std/net/index.html"target="_blank" rel="external nofollow noopener noreferrer">std::net</a></p>
</li>
<li>
<p>Macro <a href="https://doc.rust-lang.org/std/macro.eprintln.html"target="_blank" rel="external nofollow noopener noreferrer">std::eprintln</a></p>
</li>
<li>
<p>method <a href="https://doc.rust-lang.org/std/result/enum.Result.html#method.expect"target="_blank" rel="external nofollow noopener noreferrer">std::result::Result::expect</a></p>
</li>
<li>
<p>method <a href="https://doc.rust-lang.org/std/primitive.u16.html#method.from_be_bytes"target="_blank" rel="external nofollow noopener noreferrer">u16::from_be_bytes</a></p>
</li>
</ul>
<h3 id="crate-tun_taphttpsdocsrstun-taplatesttun_tap">Crate <a href="https://docs.rs/tun-tap/latest/tun_tap/"target="_blank" rel="external nofollow noopener noreferrer">tun_tap</a></h3>
<ul>
<li>Enum <a href="https://docs.rs/tun-tap/latest/tun_tap/enum.Mode.html"target="_blank" rel="external nofollow noopener noreferrer">tun_tap::Mode</a></li>
</ul>
<h3 id="crate-etherparsehttpsdocsrsetherparselatestetherparseindexhtml">Crate <a href="https://docs.rs/etherparse/latest/etherparse/index.html"target="_blank" rel="external nofollow noopener noreferrer">etherparse</a></h3>
<ul>
<li>Struct <a href="https://docs.rs/etherparse/latest/etherparse/struct.Ipv4HeaderSlice.html"target="_blank" rel="external nofollow noopener noreferrer">etherparse::Ipv4HeaderSlice</a></li>
<li>Struct <a href="https://docs.rs/etherparse/latest/etherparse/struct.Ipv4Header.html"target="_blank" rel="external nofollow noopener noreferrer">etherparse::Ipv4Header</a></li>
<li>Struct <a href="https://docs.rs/etherparse/latest/etherparse/struct.TcpHeaderSlice.html"target="_blank" rel="external nofollow noopener noreferrer">etherparse::TcpHeaderSlice</a></li>
<li>Struct <a href="https://docs.rs/etherparse/latest/etherparse/struct.TcpHeader.html"target="_blank" rel="external nofollow noopener noreferrer">etherparse::TcpHeader</a></li>
</ul>
<h2 id="references">References</h2>
<ul>
<li><a href="https://datatracker.ietf.org/doc/html/rfc793"target="_blank" rel="external nofollow noopener noreferrer">https://datatracker.ietf.org/doc/html/rfc793</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc1122"target="_blank" rel="external nofollow noopener noreferrer">https://datatracker.ietf.org/doc/html/rfc1122</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc7414#section-2"target="_blank" rel="external nofollow noopener noreferrer">https://datatracker.ietf.org/doc/html/rfc7414#section-2</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc2398"target="_blank" rel="external nofollow noopener noreferrer">https://datatracker.ietf.org/doc/html/rfc2398</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc2525"target="_blank" rel="external nofollow noopener noreferrer">https://datatracker.ietf.org/doc/html/rfc2525</a></li>
<li><a href="https://datatracker.ietf.org/doc/html/rfc791"target="_blank" rel="external nofollow noopener noreferrer">https://datatracker.ietf.org/doc/html/rfc791</a></li>
</ul>
<div class="details admonition note open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><ul>
<li>RFC 793 描述了原始的 TCP 协议的内容</li>
<li>RFC 1122 则是对原始的 TCP 功能的一些扩展进行说明</li>
<li>RFC 7414 的 Section 2 则对 TCP 的核心功能进行了简要描述</li>
<li>RFC 2398 描述了对实现的 TCP 的一些测试方法和工具</li>
<li>RFC 2525 说明了在实现 TCP 过程中可能会出现的错误，并指出可能导致错误的潜在问题</li>
<li>RFC 791 描述了 IP 协议</li>
</ul>
</div>
    </div>
  </div></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2024-02-19 14:19:25">更新于 2024-02-19&nbsp;</span>
      </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/posts/rust-tcp/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://ccrysisa.github.io/posts/rust-tcp/" data-title="Implementing TCP/IP in Rust" data-hashtags="Rust,TCP,Network"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://ccrysisa.github.io/posts/rust-tcp/" data-hashtag="Rust"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://ccrysisa.github.io/posts/rust-tcp/" data-title="Implementing TCP/IP in Rust" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://ccrysisa.github.io/posts/rust-tcp/" data-title="Implementing TCP/IP in Rust"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://ccrysisa.github.io/posts/rust-tcp/" data-title="Implementing TCP/IP in Rust"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://ccrysisa.github.io/posts/rust-tcp/" data-title="Implementing TCP/IP in Rust" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://ccrysisa.github.io/posts/rust-tcp/" data-title="Implementing TCP/IP in Rust" data-description=""><i class="fa-brands fa-blogger fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://ccrysisa.github.io/posts/rust-tcp/" data-title="Implementing TCP/IP in Rust"><i class="fa-brands fa-evernote fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/rust/' class="post-tag">Rust</a><a href='/tags/tcp/' class="post-tag">TCP</a><a href='/tags/network/' class="post-tag">Network</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/linux-quiz1/" class="post-nav-item" rel="prev" title="Linux 核心设计: 第 1 周测验题 linked list"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>Linux 核心设计: 第 1 周测验题 linked list</a>
      <a href="/posts/linux2023-lab0/" class="post-nav-item" rel="next" title="Linux 核心设计: C Programming Lab">Linux 核心设计: C Programming Lab<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.121.2">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.18-lts.5"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/ccrysisa"target="_blank" rel="external nofollow noopener noreferrer">ccrysisa</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lunr/lunr.min.js" defer></script><script src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script src="/lib/lunr/lunr.zh.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":20},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js" defer></script></body>
</html>

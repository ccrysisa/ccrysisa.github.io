<!DOCTYPE html>
<html itemscope itemtype="http://schema.org/WebPage" lang="zh-CN">
  <head>
    
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
    <meta name="robots" content="noodp" />
    <title>你所不知道的 C 语言: 指针篇 - KZnight&#39;s Blog</title><meta name="author" content="ccrysisa">
<meta name="author-link" content="https://github.com/ccrysisa">
<meta name="description" content="
「指针」 扮演 「记忆体」 和 「物件」 之间的桥梁


原文地址
" /><meta name="keywords" content='Sysprog, C, Pointer' /><meta itemprop="name" content="你所不知道的 C 语言: 指针篇">
<meta itemprop="description" content="
「指针」 扮演 「记忆体」 和 「物件」 之间的桥梁


原文地址
"><meta itemprop="datePublished" content="2024-01-14T22:41:38+08:00" />
<meta itemprop="dateModified" content="2024-03-19T21:03:19+08:00" />
<meta itemprop="wordCount" content="4267"><meta itemprop="image" content="https://ccrysisa.github.io/logo.png" />
<meta itemprop="keywords" content="Sysprog,C,Pointer," /><meta property="og:title" content="你所不知道的 C 语言: 指针篇" />
<meta property="og:description" content="
「指针」 扮演 「记忆体」 和 「物件」 之间的桥梁


原文地址
" />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://ccrysisa.github.io/posts/c-pointer/" /><meta property="og:image" content="https://ccrysisa.github.io/logo.png" /><meta property="article:section" content="posts" />
<meta property="article:published_time" content="2024-01-14T22:41:38+08:00" />
<meta property="article:modified_time" content="2024-03-19T21:03:19+08:00" />

<meta name="twitter:card" content="summary_large_image" />
<meta name="twitter:image" content="https://ccrysisa.github.io/logo.png" /><meta name="twitter:title" content="你所不知道的 C 语言: 指针篇"/>
<meta name="twitter:description" content="
「指针」 扮演 「记忆体」 和 「物件」 之间的桥梁


原文地址
"/>
<meta name="application-name" content="FixIt">
<meta name="apple-mobile-web-app-title" content="FixIt"><meta name="theme-color" data-light="#f8f8f8" data-dark="#252627" content="#f8f8f8"><meta name="msapplication-TileColor" content="#da532c"><link rel="shortcut icon" type="image/x-icon" href="/favicon.ico" />
    <link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
    <link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5"><link rel="manifest" href="/site.webmanifest"><link rel="canonical" href="https://ccrysisa.github.io/posts/c-pointer/" /><link rel="prev" href="https://ccrysisa.github.io/posts/nthu-computer-network/" /><link rel="next" href="https://ccrysisa.github.io/posts/debug-gdb/" /><link rel="stylesheet" href="/css/style.min.css"><link rel="preload" href="/lib/fontawesome-free/all.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/fontawesome-free/all.min.css"></noscript><link rel="preload" href="/lib/animate/animate.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/animate/animate.min.css"></noscript><script type="application/ld+json">
  {
    "@context": "http://schema.org",
    "@type": "BlogPosting",
    "headline": "你所不知道的 C 语言: 指针篇",
    "inLanguage": "zh-CN",
    "mainEntityOfPage": {
      "@type": "WebPage",
      "@id": "https:\/\/ccrysisa.github.io\/posts\/c-pointer\/"
    },"genre": "posts","keywords": "Sysprog, C, Pointer","wordcount":  4267 ,
    "url": "https:\/\/ccrysisa.github.io\/posts\/c-pointer\/","datePublished": "2024-01-14T22:41:38+08:00","dateModified": "2024-03-19T21:03:19+08:00","publisher": {
      "@type": "Organization",
      "name": ""},"author": {
        "@type": "Person",
        "name": "ccrysisa"
      },"description": ""
  }
  </script></head>
  <body data-header-desktop="sticky" data-header-mobile="auto"><script>(window.localStorage?.getItem('theme') ? localStorage.getItem('theme') === 'dark' : ('auto' === 'auto' ? window.matchMedia('(prefers-color-scheme: dark)').matches : 'auto' === 'dark')) && document.body.setAttribute('data-theme', 'dark');</script><div class="wrapper" data-page-style="normal"><header class="desktop animate__faster" id="header-desktop">
  <div class="header-wrapper">
    <div class="header-title">
      <a href="/" title="KZnight&#39;s Blog"><img loading="lazy" src="/fixit.min.svg" data-title="KZnight&#39;s Blog" data-alt="KZnight&#39;s Blog" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">KZnight&#39;s Blog</span></a><span class="header-subtitle"></span></div>
    <nav>
      <ul class="menu"><li class="menu-item">
              <a
                class="menu-link"
                href="/posts/"
                
                
              ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/categories/"
                
                
              ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li class="menu-item">
              <a
                class="menu-link"
                href="/tags/"
                
                
              ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item delimiter"></li><li class="menu-item search" id="search-desktop">
            <input type="text" placeholder="搜索文章标题或内容……" id="search-input-desktop">
            <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-desktop" title="搜索">
              <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
            </a>
            <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-desktop" title="清空">
              <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
            </a>
            <span class="search-button search-loading" id="search-loading-desktop">
              <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
            </span>
          </li><li class="menu-item theme-switch" title="切换主题">
          <i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i>
        </li></ul>
    </nav>
  </div>
</header><header class="mobile animate__faster" id="header-mobile">
  <div class="header-container">
    <div class="header-wrapper">
      <div class="header-title">
        <a href="/" title="KZnight&#39;s Blog"><img loading="lazy" src="/fixit.min.svg" data-title="/fixit.min.svg" data-alt="/fixit.min.svg" class="logo" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/><span class="header-title-text">KZnight&#39;s Blog</span></a><span class="header-subtitle"></span></div>
      <div class="menu-toggle" id="menu-toggle-mobile">
        <span></span><span></span><span></span>
      </div>
    </div>
    <nav>
      <ul class="menu" id="menu-mobile"><li class="search-wrapper">
            <div class="search mobile" id="search-mobile">
              <input type="text" placeholder="搜索文章标题或内容……" id="search-input-mobile">
              <a href="javascript:void(0);" class="search-button search-toggle" id="search-toggle-mobile" title="搜索">
                <i class="fa-solid fa-search fa-fw" aria-hidden="true"></i>
              </a>
              <a href="javascript:void(0);" class="search-button search-clear" id="search-clear-mobile" title="清空">
                <i class="fa-solid fa-times-circle fa-fw" aria-hidden="true"></i>
              </a>
              <span class="search-button search-loading" id="search-loading-mobile">
                <i class="fa-solid fa-spinner fa-fw fa-spin" aria-hidden="true"></i>
              </span>
            </div>
            <a href="javascript:void(0);" class="search-cancel" id="search-cancel-mobile">
              取消
            </a>
          </li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/posts/"
                  
                  
                ><i class="fa-solid fa-archive fa-fw fa-sm" aria-hidden="true"></i> Posts</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/categories/"
                  
                  
                ><i class="fa-solid fa-th fa-fw fa-sm" aria-hidden="true"></i> Categories</a></li><li
              class="menu-item"
            ><a
                  class="menu-link"
                  href="/tags/"
                  
                  
                ><i class="fa-solid fa-tags fa-fw fa-sm" aria-hidden="true"></i> Tags</a></li><li class="menu-item menu-system">
          <span class="menu-system-item theme-switch" title="切换主题"><i class="fa-solid fa-adjust fa-fw" aria-hidden="true"></i></span></li>
      </ul>
    </nav>
  </div>
</header><div class="search-dropdown desktop">
    <div id="search-dropdown-desktop"></div>
  </div>
  <div class="search-dropdown mobile">
    <div id="search-dropdown-mobile"></div>
  </div><main class="container"><aside class="toc" id="toc-auto"><h2 class="toc-title">目录&nbsp;<i class="toc-icon fa-solid fa-angle-down fa-fw" aria-hidden="true"></i></h2>
      <div class="toc-content" id="toc-content-auto"></div></aside>

  <aside class="aside-custom">
    </aside>

  <article class="page single">
    <div class="header"><h1 class="single-title animate__animated animate__flipInX"><span title="转载" class="icon-repost"><i class="fa-solid fa-share fa-fw" aria-hidden="true"></i></span><span>你所不知道的 C 语言: 指针篇</span>
      </h1></div><div class="post-meta">
      <div class="post-meta-line"><span class="post-author"><a href="https://github.com/ccrysisa" title="作者"target="_blank" rel="external nofollow noopener noreferrer author" class="author"><img loading="lazy" src="https://avatars.githubusercontent.com/u/133117003?s=400&amp;v=4" data-title="ccrysisa" data-alt="ccrysisa" class="avatar" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/>&nbsp;ccrysisa</a></span>
          <span class="post-category">收录于 <a href="/categories/c/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> C</a>&ensp;<a href="/categories/linux-kernel-internals/"><i class="fa-regular fa-folder fa-fw" aria-hidden="true"></i> Linux Kernel Internals</a></span></div>
      <div class="post-meta-line"><span title="发布于 2024-01-14 22:41:38"><i class="fa-regular fa-calendar-alt fa-fw me-1" aria-hidden="true"></i><time datetime="2024-01-14">2024-01-14</time></span>&nbsp;<span title="更新于 2024-03-19 21:03:19"><i class="fa-regular fa-edit fa-fw me-1" aria-hidden="true"></i><time datetime="2024-03-19">2024-03-19</time></span>&nbsp;<span title="4267 字"><i class="fa-solid fa-pencil-alt fa-fw me-1" aria-hidden="true"></i>约 4300 字</span>&nbsp;<span><i class="fa-regular fa-clock fa-fw me-1" aria-hidden="true"></i>预计阅读 9 分钟</span>&nbsp;</div>
    </div><div class="details toc" id="toc-static" data-kept="false">
        <div class="details-summary toc-title">
          <span>目录</span>
          <span><i class="details-icon fa-solid fa-angle-right" aria-hidden="true"></i></span>
        </div>
        <div class="details-content toc-content" id="toc-content-static"><nav id="TableOfContents">
  <ul>
    <li><a href="#前言杂谈">前言杂谈</a></li>
    <li><a href="#阅读-c-语言规格书">阅读 C 语言规格书</a></li>
    <li><a href="#void--void-">void &amp; void *</a>
      <ul>
        <li><a href="#alignment">Alignment</a></li>
        <li><a href="#规格书中的-pointer">规格书中的 Pointer</a></li>
      </ul>
    </li>
    <li><a href="#pointers-vs-arrays">Pointers vs. Arrays</a>
      <ul>
        <li><a href="#gdb-实作">GDB 实作</a></li>
        <li><a href="#runtime-environment">Runtime Environment</a></li>
      </ul>
    </li>
    <li><a href="#function-pointer">Function Pointer</a></li>
    <li><a href="#指针的修饰符">指针的修饰符</a></li>
    <li><a href="#字符串">字符串</a></li>
    <li><a href="#linus-的教导">Linus 的“教导”</a></li>
    <li><a href="#lvalue--rvalue">Lvalue &amp; Rvalue</a></li>
  </ul>
</nav></div>
      </div><div class="content" id="content"><blockquote>
<p><em>「指针」 扮演 「记忆体」 和 「物件」 之间的桥梁</em></p>
</blockquote>
<ul>
<li><a href="https://hackmd.io/@sysprog/c-pointer"target="_blank" rel="external nofollow noopener noreferrer">原文地址<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a></li>
</ul>
<h2 id="前言杂谈">前言杂谈</h2>
<p><a href="https://www.youtube.com/watch?v=l5Mp_DEn4bs"target="_blank" rel="external nofollow noopener noreferrer">Let’s learn programming by inventing it</a> [CppCon 2018] &#x2705;</p>
<blockquote>
<p>在 K&amp;R 一书中，直到 93 页才开始谈论 pointer，而全书总计 185 页，所以大概是在全书 $50.27\%$ 的位置才开始讲 pointer。所以即使不学 pointer，你还是能够掌握 $~50\%$ 的 C 语言的内容，但是 C 语言的核心正是 pointer，所以 Good Luck &#x1f923;</p>
</blockquote>
<p><a href="http://gcc.godbolt.org/"target="_blank" rel="external nofollow noopener noreferrer">godbolt</a> 可以直接在网页上看到，源代码由各类 compiler 生成的 Assembly Code</p>
<p><a href="">How to read this prototype?</a> [Stack Overflow] &#x2705;
<details>
  <summary>Note</summary>
  <p>这个问题是关于 <code>signal</code> 系统调用的函数原型解读，里面的回答页给出了很多对于指针，特别是 <em>函数指针</em> 的说明，下面节选一些特别有意思的回答：</p>
<blockquote>
<p>The whole thing declares a function called <code>signal</code>:</p>
<ul>
<li><code>signal</code> takes an int and a function pointer
<ul>
<li>this function pointer takes an <code>int</code> and returns <code>void</code></li>
</ul>
</li>
<li><code>signal</code> returns a function pointer
<ul>
<li><code>this function pointer takes an </code>int<code>and returns a</code>void`</li>
</ul>
</li>
</ul>
<p>That&rsquo;s where the last int comes in.</p>
<hr>
<p>You can use <a href="https://c-faq.com/decl/spiral.anderson.html"target="_blank" rel="external nofollow noopener noreferrer">the spiral rule</a> to make sense of such declarations, or the program <code>cdecl(1)</code>.</p>
</blockquote>
<p>这里面提到了 <a href="https://c-faq.com/decl/spiral.anderson.html"target="_blank" rel="external nofollow noopener noreferrer">the spiral rule</a> 这是一个用于解析 C 语言中声明 (declaration) 的方法；另外还提到了 <code>cdecl</code> 这一程序，它也有类似的作用，可以使用英文进行声明或者解释。</p>
<hr>
<blockquote>
<p>Find the leftmost identifier and work your way out, remembering that <code>[]</code> and <code>()</code> bind before <code>*</code>; IOW, <code>*a[]</code> is an array of pointers, <code>(*a)[]</code> is a pointer to an array, <code>*f()</code> is a function returning a pointer, and <code>(*f)()</code> is a pointer to a function. Thus,</p>
<div class="highlight" id="id-13"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">void</span> <span class="p">(</span> <span class="o">*</span><span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span> <span class="p">)</span> <span class="p">(</span><span class="kt">int</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>breaks down as</p>
<div class="highlight" id="id-14"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl">        <span class="n">signal</span>                                          <span class="o">--</span> <span class="n">signal</span>
</span></span><span class="line"><span class="cl">        <span class="nf">signal</span><span class="p">(</span>                               <span class="p">)</span>         <span class="o">--</span> <span class="n">is</span> <span class="n">a</span> <span class="n">function</span>
</span></span><span class="line"><span class="cl">        <span class="nf">signal</span><span class="p">(</span>    <span class="n">sig</span>                        <span class="p">)</span>         <span class="o">--</span> <span class="n">with</span> <span class="n">a</span> <span class="n">parameter</span> <span class="n">named</span> <span class="n">sig</span>
</span></span><span class="line"><span class="cl">        <span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span>                       <span class="p">)</span>         <span class="o">--</span>   <span class="n">of</span> <span class="n">type</span> <span class="kt">int</span>
</span></span><span class="line"><span class="cl">        <span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span>        <span class="n">handler</span>        <span class="p">)</span>         <span class="o">--</span> <span class="n">and</span> <span class="n">a</span> <span class="n">parameter</span> <span class="n">named</span> <span class="n">handler</span>
</span></span><span class="line"><span class="cl">        <span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span>       <span class="o">*</span><span class="n">handler</span>        <span class="p">)</span>         <span class="o">--</span>   <span class="n">which</span> <span class="n">is</span> <span class="n">a</span> <span class="n">pointer</span>
</span></span><span class="line"><span class="cl">        <span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span>      <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span>   <span class="p">))</span> <span class="p">)</span>         <span class="o">--</span>   <span class="n">to</span> <span class="n">a</span> <span class="n">function</span>
</span></span><span class="line"><span class="cl">        <span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span>      <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span> <span class="p">)</span>         <span class="o">--</span>   <span class="n">taking</span> <span class="n">an</span> <span class="kt">int</span> <span class="n">parameter</span>
</span></span><span class="line"><span class="cl">        <span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span> <span class="p">)</span>         <span class="o">--</span>   <span class="n">and</span> <span class="n">returning</span> <span class="kt">void</span>
</span></span><span class="line"><span class="cl">       <span class="o">*</span><span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span> <span class="p">)</span>         <span class="o">--</span> <span class="n">returning</span> <span class="n">a</span> <span class="nf">pointer</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span> <span class="o">*</span><span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span> <span class="p">)(</span>   <span class="p">)</span>    <span class="o">--</span> <span class="n">to</span> <span class="n">a</span> <span class="nf">function</span>
</span></span><span class="line"><span class="cl">     <span class="p">(</span> <span class="o">*</span><span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span> <span class="p">)(</span><span class="kt">int</span><span class="p">)</span>    <span class="o">--</span>   <span class="n">taking</span> <span class="n">an</span> <span class="kt">int</span> <span class="n">parameter</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="p">(</span> <span class="o">*</span><span class="nf">signal</span><span class="p">(</span><span class="kt">int</span> <span class="n">sig</span><span class="p">,</span> <span class="kt">void</span> <span class="p">(</span><span class="o">*</span><span class="n">handler</span><span class="p">)(</span><span class="kt">int</span><span class="p">))</span> <span class="p">)(</span><span class="kt">int</span><span class="p">);</span>   <span class="o">--</span>   <span class="n">and</span> <span class="n">returning</span> <span class="kt">void</span></span></span></code></pre></td></tr></table>
</div>
</div></blockquote>
<p>这一回答强调了 <code>*</code> 和 <code>[]</code>、<code>()</code> 优先级的关系，这在判断数组指针、函数指针时是个非常好用的技巧。</p>

</details></p>
<p>Rob Pike 于 2009/10/30 的 <a href="https://talks.golang.org/2009/go_talk-20091030.pdf"target="_blank" rel="external nofollow noopener noreferrer">Golang Talk</a> [PDF]</p>
<p>David Brailsford 教授解说影片 <a href="https://www.youtube.com/watch?v=t5NszbIerYc"target="_blank" rel="external nofollow noopener noreferrer">Essentials: Pointer Power! - Computerphile</a> [YouTube]</p>
<h2 id="阅读-c-语言规格书">阅读 C 语言规格书</h2>
<p>一手资料的重要性毋庸置疑，对于 C 语言中的核心概念 <em><strong>指针</strong></em>，借助官方规格书清晰概念是非常重要的。</p>
<p>C99 [6.2.5] <em><strong>Types</strong></em></p>
<blockquote>
<p>An array type of unknown size is an incomplete type. It is completed, for an identifier of that type, by specifying the size in a later declaration (with internal or external linkage). A structure or union type of unknown content is an incomplete type. It is completed, for all declarations of that type, by declaring the same structure or union tag with its defining content later in the same scope.</p>
</blockquote>
<p><em>incomplete type</em> 和 <em>linkage</em> 配合可以进行 forward declaration，如果搭配 pointer 则可以进一步，在无需知道 object 内部细节即可进行程序开发。</p>
<blockquote>
<p>Array, function, and pointer types are collectively called derived declarator types. A declarator type derivation from a type T is the construction of a derived declarator type from T by the application of an array-type, a function-type, or a pointer-type derivation to T.</p>
</blockquote>
<div class="details admonition note open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><em>derived declarator types</em>  表示衍生的声明类型，因为 array, function, pointer 本质都是地址，而它们的类型都是由其它类型衍生而来的，所以可以使用这些所谓的 <em>derived declarator types</em> 来提前声明 object，表示在某个地址会存储一个 object，这也是为什么这些类型被规格书定义为 <em>derived declarator types</em>。</div>
    </div>
  </div>
<ul>
<li><strong>lvalue</strong>: Locator value</li>
</ul>
<div class="details admonition danger open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-skull-crossbones fa-fw" aria-hidden="true"></i>危险<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">C 语言里只有 <em><strong>call by value</strong></em></div>
    </div>
  </div>
<h2 id="void--void-">void &amp; void *</h2>
<p>C89 之前，函数如果没有标注返回类型，则默认返回类型 <code>int</code>，返回值 0。但由于这样既可以表示返回值不重要，也可以表示返回值为 0，这会造成歧义，所以引进了 <code>void</code>。</p>
<p><code>void *</code> 只能表示地址，而不能对所指向的地址区域的内容进行操作。因为通过 <code>void *</code> 无法知道所指向区域的 size，所以无法对区域的内容进行操作，必须对 <code>void *</code> 进行 <em><strong>显示转换</strong></em> 才能操作指向的内容。（除此之外，<strong>针对于 gcc</strong>，对于指针本身的操作，<code>void *</code> 与 <code>char *</code> 是等价的，即对于 <code>+/- 1</code> 这类的操作，二者的偏移量是一致的 (这是 GNU extensions 并不是 C 语言标准)；对于其它的编译器，建议将 <code>void *</code> 转换成 <code>char *</code> 再进行指针的加减运算）</p>
<h3 id="alignment">Alignment</h3>
<p>这部分原文描述不是很清晰，<code>2-byte aligned</code> 图示如下：</p>
<figure><a class="lightgallery" href="/images/c/2-byte-aligned.svg?size=large" data-thumbnail="/images/c/2-byte-aligned.svg?size=small" data-sub-html="<h2>Alignment</h2>"><img loading="lazy" src="/images/c/2-byte-aligned.svg" srcset="/images/c/2-byte-aligned.svg?size=small, /images/c/2-byte-aligned.svg?size=medium 1.5x, /images/c/2-byte-aligned.svg?size=large 2x" sizes="auto" data-title="/images/c/2-byte-aligned.svg" data-alt="/images/c/2-byte-aligned.svg" class="suffix-invalid suffix-invalid__small suffix-invalid__large" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/></a><figcaption class="image-caption">Alignment</figcaption>
  </figure>
<p>如果是 2-byte aligned 且是 little-endian 的处理器，对于左边，可以直接使用 <code>*(uint16_t *) ptr</code>，但对于右边就无法这样（不符合 alignment）：</p>
<div class="highlight" id="id-1"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* may receive wrong value if ptr is not 2-byte aligned */</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint16_t</span> <span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint16_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* portable way of reading a little-endian value */</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint16_t</span> <span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span> <span class="o">|</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>因为内存寻址的最小粒度是 Byte，所以使用 <code>(uint_8 *)</code> 不需要担心 alignment 的问题。原文并没有给出 32-bit aligned 的 portable way，我们来写一下：</p>
<div class="highlight" id="id-2"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cm">/* may receive wrong value if ptr is not 2-byte aligned */</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/* portable way of reading a little-endian value */</span>
</span></span><span class="line"><span class="cl"><span class="kt">uint32_t</span> <span class="n">value</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">ptr</span> 
</span></span><span class="line"><span class="cl">                 <span class="o">|</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                 <span class="o">|</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">16</span><span class="p">)</span> 
</span></span><span class="line"><span class="cl">                 <span class="o">|</span> <span class="p">((</span><span class="o">*</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="p">)</span> <span class="p">(</span><span class="n">ptr</span> <span class="o">+</span> <span class="mi">3</span><span class="p">))</span> <span class="o">&lt;&lt;</span> <span class="mi">24</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="details admonition info open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-info-circle fa-fw" aria-hidden="true"></i>信息<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><ul>
<li><i class="fa-regular fa-square fa-fw" aria-hidden="true"></i> <a href="http://www.catb.org/esr/structure-packing/"target="_blank" rel="external nofollow noopener noreferrer">The Lost Art of Structure Packing</a></li>
</ul>
</div>
    </div>
  </div>
<h3 id="规格书中的-pointer">规格书中的 Pointer</h3>
<p>C99 [6.3.2.3] <em><strong>Pointers</strong></em></p>
<blockquote>
<p>A pointer to a function of one type may be converted to a pointer to a function of another
type and back again; the result shall compare equal to the original pointer. Ifaconverted
pointer is used to call a function whose type is not compatible with the pointed-to type,
the behavior is undefined.</p>
</blockquote>
<p>C11 [6.3.2.3] <em><strong>Pointers</strong></em></p>
<blockquote>
<p>A pointer to a function of one type may be converted to a pointer to a function of another
type and back again; the result shall compare equal to the original pointer. If a converted
pointer is used to call a function whose type is not compatible with the referenced type,
the behavior is undefined.</p>
</blockquote>
<p><strong>C99 和 C11 都不保证 pointers (whose type is not compatible with the <em>pointed-to / referenced</em> type) 之间的转换是正确的。</strong></p>
<p>导致这个的原因正是之前所提的 Alignment，转换后的指针类型不一定满足原有类型的 Alignment 要求，这种情况下进行 dereference 会导致异常。例如将一个 <code>char *</code> 指针转换成 <code>int *</code> 指针，然后进行 deference 有可能会产生异常。</p>
<h2 id="pointers-vs-arrays">Pointers vs. Arrays</h2>
<p>C99 6.3.2.1</p>
<blockquote>
<p>Except when it is the operand of the sizeof operator or the unary &amp; operator, or is a string literal used to initialize an array, an expression that has type ‘‘array of type’’ is converted to an expression with type ‘‘pointer to type’’ that points to the initial element of the array object and is not an lvalue.</p>
</blockquote>
<p>Array 只有在表示其自身为数组时才不会被 converted to Pointer，例如</p>
<div class="highlight" id="id-3"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// case 1: extern declaration of array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">extern</span> <span class="kt">char</span> <span class="n">a</span><span class="p">[];</span>
</span></span><span class="line"><span class="cl"><span class="c1">// case 2: defintion of array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="n">a</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="c1">// case 3: size of array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">sizeof</span><span class="p">(</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// case 4: address of array
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="o">&amp;</span><span class="n">a</span></span></span></code></pre></td></tr></table>
</div>
</div><p>在其他情况则会倍 converted to Pointer，这时 Array 可以和 Pointer 互换进行表示或操作，例如</p>
<div class="highlight" id="id-4"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="c1">// case 1: function parameter
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">char</span> <span class="n">a</span><span class="p">[]);</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">func</span><span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="n">a</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// case 2: operation in expression
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">a</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这也是为什么对于一个 Array <code>a</code>，<code>&amp;a</code> 和 <code>&amp;a[0]</code> 值虽然相同，但 <code>&amp;a + 1</code> 和 <code>&amp;a[0] + 1</code> 的结果大部分时候是大不相同的，这件事乍一看是非常惊人的，但其实不然，在了解 Array 和 Pointer 之后，也就那么一回事 &#x1f923;</p>
<a href="https://github.com/ccrysisa/LKI/blob/main/c-pointer"target="_blank" rel="external nofollow noopener noreferrer">Source<i class="fa-solid fa-external-link-alt fa-fw fa-xs ms-1 text-secondary" aria-hidden="true"></i></a>
<h3 id="gdb-实作">GDB 实作</h3>
<div class="highlight" id="id-5"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">a</span><span class="p">[</span><span class="mi">10</span><span class="p">];</span>
</span></span><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">main</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span></span></span></code></pre></td></tr></table>
</div>
</div><p>我们以上面这个例子，通过 GDB 来对 Array 和 Pointer 进行深入研究：</p>
<div class="highlight" id="id-6"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> print <span class="p">&amp;</span>a
</span></span><span class="line"><span class="cl"><span class="nv">$1</span> <span class="o">=</span> <span class="o">(</span>char <span class="o">(</span>*<span class="o">)[</span>10<span class="o">])</span> 0x555555558018 &lt;a&gt;
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> print <span class="p">&amp;</span>a<span class="o">[</span>0<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nv">$2</span> <span class="o">=</span> 0x555555558018 &lt;a&gt; <span class="s2">&#34;&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>符合预期，<code>&amp;a</code> 和 <code>&amp;a[0]</code> 得到的值是相同的，虽然类型看起来不同，但是现在先放到一边。</p>
<div class="highlight" id="id-7"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> print <span class="p">&amp;</span>a + <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">$3</span> <span class="o">=</span> <span class="o">(</span>char <span class="o">(</span>*<span class="o">)[</span>10<span class="o">])</span> 0x555555558022
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> print <span class="p">&amp;</span>a<span class="o">[</span>0<span class="o">]</span> + <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">$4</span> <span class="o">=</span> 0x555555558019 &lt;a+1&gt; <span class="s2">&#34;&#34;</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> print a + <span class="m">1</span>
</span></span><span class="line"><span class="cl"><span class="nv">$5</span> <span class="o">=</span> 0x555555558019 &lt;a+1&gt; <span class="s2">&#34;&#34;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Oh! 正如我们之前所说的 <code>&amp;a + 1</code> 与 <code>&amp;a[0] + 1</code> 结果并不相同（而 <code>&amp;a[0] + 1</code> 和 <code>a + 1</code> 结果相同正是我们所提到的 Array 退化为 Pointer），虽然如此，GDB 所给的信息提示我们可能是二者 Pointer 类型不相同导致的。</p>
<div class="highlight" id="id-8"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> whatis <span class="p">&amp;</span>a
</span></span><span class="line"><span class="cl"><span class="nb">type</span> <span class="o">=</span> char <span class="o">(</span>*<span class="o">)[</span>10<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> whatis <span class="p">&amp;</span>a<span class="o">[</span>0<span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="nb">type</span> <span class="o">=</span> char *</span></span></code></pre></td></tr></table>
</div>
</div><p>Great! 果然是 Pointer 类型不同导致的，我们可以看到 <code>&amp;a</code> 的类型是 <code>char (*)[10]</code> 一个指向 Array 的指针，<code>&amp;a[0]</code> 则是 <code>char *</code>。所以这两个 Pointer 在进行 <code>+/-</code> 运算时的偏移量是不同的，<code>&amp;a[0]</code> 的偏移量为 <code>sizeof(a[0])</code> 即一个 <code>char</code> 的宽度 ($0x18 + 1 = 0x19$)，而 <code>&amp;a</code> 的偏移量为 <code>sizeof(a)</code> 即 10 个 <code>char</code> 的宽度 ($0x18 + 10 = 0x22$)。</p>
<div class="details admonition warning open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-exclamation-triangle fa-fw" aria-hidden="true"></i>警告<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><p>在 GDB 中使用 <code>memcpy</code> 后直接打印可能会出现以下错误：</p>
<div class="highlight" id="id-15"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> p memcpy<span class="o">(</span>calendar, b, sizeof<span class="o">(</span>b<span class="o">[</span>0<span class="o">]))</span>
</span></span><span class="line"><span class="cl"><span class="s1">&#39;memcpy&#39;</span> has unknown <span class="k">return</span> type<span class="p">;</span> cast the call to its declared <span class="k">return</span> type</span></span></code></pre></td></tr></table>
</div>
</div><p>只需加入 <code>void *</code> 进行类型转换即可解决该问题：</p>
<div class="highlight" id="id-16"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="o">(</span>gdb<span class="o">)</span> p <span class="o">(</span>void *<span class="o">)</span> memcpy<span class="o">(</span>calendar, b, sizeof<span class="o">(</span>b<span class="o">[</span>0<span class="o">]))</span>
</span></span><span class="line"><span class="cl">...</span></span></code></pre></td></tr></table>
</div>
</div></div>
    </div>
  </div>
<div class="details admonition tip open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-lightbulb fa-fw" aria-hidden="true"></i>技巧<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content">遇到陌生的函数，可以使用 <code>man</code> 来快速查阅手册，例如 <code>man strcpy</code>, <code>man strcat</code>，手册可以让我们快速查询函数的一些信息，从而进入实作。</div>
    </div>
  </div>
<h3 id="runtime-environment">Runtime Environment</h3>
<p>根据 <a href="https://news.ycombinator.com/item?id=11674374"target="_blank" rel="external nofollow noopener noreferrer">Zero size arrays in C </a>，原文中的 <code>char (*argv)[0]</code> 在函数参数传递时会被转换成 <code>char **argv</code>。而为什么在查看地址 <code>((char **) argv)[0]</code> 开始的连续 4 个 <code>char *</code> 内容时，会打印出 <code>envp</code> 中的内容，可以参考以下的进入 <code>main</code> 函数时的栈布局：</p>
<a class="lightgallery" href="/images/c/argv.png?size=large" data-thumbnail="/images/c/argv.png?size=small" data-sub-html="<h2>/images/c/argv.png</h2>"><img loading="lazy" src="/images/c/argv.png" srcset="/images/c/argv.png?size=small, /images/c/argv.png?size=medium 1.5x, /images/c/argv.png?size=large 2x" sizes="auto" data-title="/images/c/argv.png" data-alt="/images/c/argv.png" style="background: url(/svg/loading.min.svg) no-repeat center;" onload="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}this.dataset.lazyloaded='';" onerror="this.title=this.dataset.title;this.alt=this.dataset.alt;for(const i of ['style', 'data-title','data-alt','onerror','onload']){this.removeAttribute(i);}"/></a>
<p><code>argv</code> 和 <code>envp</code> 所指的字符串区域是相连的，所以在越过 <code>argv</code> 字符串区域的边界后，会继续打印 <code>envp</code> 区域的字符串。这也是为什么打印出的字符串之间地址增长于其长度相匹配。所以从地址 <code>(char **) argv</code> 开始的区域只是一个 <code>char *</code> 数组，使用 <code>x/4s</code> 对这部分进行字符串格式打印显然是看不懂的。</p>
<div class="details admonition note open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-pencil-alt fa-fw" aria-hidden="true"></i>注意<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><p><code>argv</code> 和 <code>envp</code> 都是在 shell 进行 <code>exec</code> 系统调用之前进行传递（事实上是以 arguments 的形式传递给 <code>exec</code>）</p>
<p>man 2 execve</p>
<div class="highlight" id="id-17"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">int</span> <span class="nf">execve</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">pathname</span><span class="p">,</span> <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">argv</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">           <span class="kt">char</span> <span class="o">*</span><span class="k">const</span> <span class="n">envp</span><span class="p">[]);</span></span></span></code></pre></td></tr></table>
</div>
</div><p><code>execve</code> 实际上在内部调用了 <code>fork</code>，所以 <code>argv</code> 和 <code>envp</code> 的传递是在 <code>fork</code> 之前。（设想如果是在 <code>fork</code> 之后传递，可能会出现 <code>fork</code> 后 child process 先执行，这种情况 child process 显然无法获得这些被传递的信息）</p>
<p>注意到 <code>execve</code> 只传递了 <code>argv</code> 而没有传递 <code>argc</code>，这也很容易理解，<code>argc</code> 是 <code>argv</code> 的计数，只需 <code>argv</code> 即可推导出 <code>argc</code>。</p>
</div>
    </div>
  </div>
<h2 id="function-pointer">Function Pointer</h2>
<div class="details admonition danger open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-skull-crossbones fa-fw" aria-hidden="true"></i>危险<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><p>与 Array 类似，Function 只有在表示自身时不会被 converted to Function Pointer (即除 <code>sizeof</code> 和 <code>&amp;</code> 运算之外)，其它情况、运算时都会被 convert to Function Pointer</p>
<p>理解 C 语言中的 Function 以及 Function Pointer 的核心在于理解 <em><strong>Function Designator</strong></em> 这个概念，函数名字必然是 Function Designator，其它的 designator 则是根据以下两条规则进行推导得来。</p>
</div>
    </div>
  </div>
<p>C99 [ 6.3.2.1 ]</p>
<blockquote>
<p>A function designator is an expression that has function type. <strong>Except</strong> when it is the operand of the <strong>sizeof</strong> operator or the unary <strong>&amp;</strong> operator, a <strong>function designator</strong> with type ‘‘function returning type’’ <strong>is converted to</strong> an expression that has type ‘‘<strong>pointer to function returning type</strong>’’.</p>
</blockquote>
<p>C99 [6.5.3.2-4]</p>
<blockquote>
<p>The unary * operator denotes indirection. <strong>If the operand points to a function, the result is a function designator.</strong></p>
</blockquote>
<h2 id="指针的修饰符">指针的修饰符</h2>
<p>指针 <code>p</code> 自身不能变更，既不能改变 <code>p</code> 自身所存储的地址。const 在 * 之后：</p>
<div class="highlight" id="id-9"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">p</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>指针 <code>p</code> 所指向的内容不能变更，即不能通过 <code>p</code> 来更改所指向的内容。const 在 * 之前：</p>
<div class="highlight" id="id-10"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="n">p</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>指针 <code>p</code> 自身于所指向的内容都不能变更：</p>
<div class="highlight" id="id-11"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="k">const</span> <span class="n">p</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="k">const</span> <span class="o">*</span> <span class="k">const</span> <span class="n">p</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="字符串">字符串</h2>
<p>对于函数内部的</p>
<div class="highlight" id="id-12"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="kt">char</span> <span class="o">*</span><span class="n">p</span>  <span class="o">=</span> <span class="s">&#34;hello&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="kt">char</span> <span class="n">p</span><span class="p">[]</span> <span class="o">=</span> <span class="s">&#34;hello&#34;</span><span class="p">;</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这两个是不一样的，因为 string literals 是必须放在 “static storage” 中，而 char p[] 则表示将资料分配在 stack 內，所以这会造成编译器隐式地生成额外代码，在执行时 (runtime) 将 string literals 从 static storage 拷贝到 stack 中，所以此时 <code>return p</code> 会造成 UB。而 <code>char *p</code> 的情形不同，此时 <code>p</code> 只是一个指向 static storage 的指针，进行 <code>return p</code> 是合法的。除此之外，无法对第一种方法的字符串进行修改操作，因为它指向的字符串存放的区域的资料是无法修改的，否则会造成 segmentationfalut &#x1f923;</p>
<p>在大部分情况下，null pointer 并不是一个有效的字符串，所以在 glibc 中字符相关的大部分函数也不会对 null pointer 进行特判 (特判会增加分支，从而影响程序效能)，所以在调用这些函数时需要用户自己判断是否为 null pointer，否则会造成 UB。</p>
<h2 id="linus-的教导">Linus 的“教导”</h2>
<p><a href="https://hackmd.io/@sysprog/c-array-argument"target="_blank" rel="external nofollow noopener noreferrer">Linus 親自教你 C 語言 array argument 的使用</a></p>
<blockquote>
<p>because array arguments in C don’t actually exist. Sadly, compilers accept it for various bad historical reasons, and silently turn it into just a pointer argument. There are arguments for them, but they are from weak minds.</p>
</blockquote>
<blockquote>
<p>The “array as function argument” syntax is occasionally useful (particularly for the multi-dimensional array case), so I very much understand why it exists, I just think that in the kernel we’d be better off with the rule that it’s against our coding practices.</p>
</blockquote>
<p>array argument 应该只用于多维数组 (multi-dimensional arrays) 的情形，这样可以保证使用下标表示时 offset 是正确的，但对于一维数组则不应该使用数组表示作为函数参数，因为这会对函数体内的 <code>sizeof</code> 用法误解 (以为会获得数组的 size，实际上获得的只是指针的 size)。</p>
<div class="details admonition tip open">
    <div class="details-summary admonition-title">
      <i class="icon fa-solid fa-lightbulb fa-fw" aria-hidden="true"></i>技巧<i class="details-icon fa-solid fa-angle-right fa-fw" aria-hidden="true"></i>
    </div>
    <div class="details-content">
      <div class="admonition-content"><p>一个常用于计算数组中元素个数的宏：</p>
<div class="highlight" id="id-18"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c" data-lang="c"><span class="line"><span class="cl"><span class="cp">#define ARRAY_SIZE(x) (sizeof(x) / sizeof((x)[0]))</span></span></span></code></pre></td></tr></table>
</div>
</div><p>这个宏非常有用，<a href="https://github.com/mit-pdos/xv6-riscv/blob/riscv/kernel/defs.h#L189"target="_blank" rel="external nofollow noopener noreferrer">xv6</a> 中使用到了这个宏。</p>
<p>但是需要注意，使用时必须保证 <code>x</code> 是一个数组，而不是函数参数中由数组退化而来的指针，以及保证数组必须至少拥有一个元素的长度 (这个很容易满足，毕竟 <code>x[0]</code> 编译器会抛出警告)。</p>
</div>
    </div>
  </div>
<h2 id="lvalue--rvalue">Lvalue &amp; Rvalue</h2>
<ul>
<li>Lvalue: locator value</li>
<li>Rvalue: Read-only value</li>
</ul>
<p>C99 6.3.2.1 footnote</p>
<blockquote>
<p>The name “lvalue” comes originally from the assignment expression E1 = E2, in which the left operand E1 is required to be a (modifiable) lvalue. It is perhaps better considered as representing an object “locator value”. What is sometimes called “rvalue” is in this International Standard described as the “value of an expression”. An obvious example of an lvalue is an identifier of an object. As a further example, if E is a unary expression that is a pointer to an object, *E is an lvalue that designates the object to which E points.</p>
</blockquote>
<p>即在 C 语言中 lvalue 是必须能在内存 (memory) 中可以定位 (locator) 的东西，因为可以定位 (locator) 所以才可以在表达式左边从而修改值。想像一下，在 C 语言中修改一个常数的值显然是不可能的，因为常数无法在内存 (memory) 定位 (locator) 所以常数在 C 语言中不是 lvalue。C 语言中除了 lvalue 之外的 value 都是 rvalue (这与 C++ 有些不同，C++ 的 lvalue 和 rvalue 的定义请参考 C++ 的规格书)。</p></div><div class="post-footer" id="post-footer">
  <div class="post-info">
    <div class="post-info-line">
      <div class="post-info-mod">
        <span title="更新于 2024-03-19 21:03:19">更新于 2024-03-19&nbsp;</span>
      </div></div>
    <div class="post-info-line">
      <div class="post-info-md"><span><a href="/posts/c-pointer/index.md" title="阅读原始文档" class="link-to-markdown">阅读原始文档</a></span></div>
      <div class="post-info-share">
        <span><a href="javascript:void(0);" title="分享到 Twitter" data-sharer="twitter" data-url="https://ccrysisa.github.io/posts/c-pointer/" data-title="你所不知道的 C 语言: 指针篇" data-hashtags="Sysprog,C,Pointer"><i class="fa-brands fa-twitter fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Facebook" data-sharer="facebook" data-url="https://ccrysisa.github.io/posts/c-pointer/" data-hashtag="Sysprog"><i class="fa-brands fa-facebook-square fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 WhatsApp" data-sharer="whatsapp" data-url="https://ccrysisa.github.io/posts/c-pointer/" data-title="你所不知道的 C 语言: 指针篇" data-web><i class="fa-brands fa-whatsapp fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Line" data-sharer="line" data-url="https://ccrysisa.github.io/posts/c-pointer/" data-title="你所不知道的 C 语言: 指针篇"><i data-svg-src="/lib/simple-icons/icons/line.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 微博" data-sharer="weibo" data-url="https://ccrysisa.github.io/posts/c-pointer/" data-title="你所不知道的 C 语言: 指针篇"><i class="fa-brands fa-weibo fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Myspace" data-sharer="myspace" data-url="https://ccrysisa.github.io/posts/c-pointer/" data-title="你所不知道的 C 语言: 指针篇" data-description=""><i data-svg-src="/lib/simple-icons/icons/myspace.min.svg" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Blogger" data-sharer="blogger" data-url="https://ccrysisa.github.io/posts/c-pointer/" data-title="你所不知道的 C 语言: 指针篇" data-description=""><i class="fa-brands fa-blogger fa-fw" aria-hidden="true"></i></a>
  <a href="javascript:void(0);" title="分享到 Evernote" data-sharer="evernote" data-url="https://ccrysisa.github.io/posts/c-pointer/" data-title="你所不知道的 C 语言: 指针篇"><i class="fa-brands fa-evernote fa-fw" aria-hidden="true"></i></a>
  </span>
      </div>
    </div>
  </div>

  <div class="post-info-more">
    <section class="post-tags"><i class="fa-solid fa-tags fa-fw me-1" aria-hidden="true"></i><a href='/tags/sysprog/' class="post-tag">Sysprog</a><a href='/tags/c/' class="post-tag">C</a><a href='/tags/pointer/' class="post-tag">Pointer</a></section>
    <section>
      <span><a href="javascript:void(0);" onclick="window.history.back();">返回</a></span>&nbsp;|&nbsp;<span><a href="/">主页</a></span>
    </section>
  </div>

  <div class="post-nav"><a href="/posts/nthu-computer-network/" class="post-nav-item" rel="prev" title="國立清華大學 計算機網路 重點提示"><i class="fa-solid fa-angle-left fa-fw" aria-hidden="true"></i>國立清華大學 計算機網路 重點提示</a>
      <a href="/posts/debug-gdb/" class="post-nav-item" rel="next" title="程序调试工具 GDB">程序调试工具 GDB<i class="fa-solid fa-angle-right fa-fw" aria-hidden="true"></i></a></div>
</div>
</article></main><footer class="footer">
    <div class="footer-container"><div class="footer-line powered">由 <a href="https://gohugo.io/" target="_blank" rel="external nofollow noopener noreferrer" title="Hugo 0.121.1">Hugo</a> 强力驱动 | 主题 - <a href="https://github.com/hugo-fixit/FixIt" target="_blank" rel="external" title="FixIt v0.2.18-lts.5"><img class="fixit-icon" src="/fixit.min.svg" alt="FixIt logo" />&nbsp;FixIt</a>
        </div><div class="footer-line copyright" itemscope itemtype="http://schema.org/CreativeWork"><i class="fa-regular fa-copyright fa-fw" aria-hidden="true"></i>
            <span itemprop="copyrightYear">2021 - 2024</span><span class="author" itemprop="copyrightHolder">
              <a href="https://github.com/ccrysisa"target="_blank" rel="external nofollow noopener noreferrer">ccrysisa</a></span><span class="license footer-divider"><a rel="license external nofollow noopener noreferrer" href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a></span></div><div class="footer-line statistics"></div><div class="footer-line visitor">
          <span id="busuanzi_container_site_uv" title='总访客数'><i class="fa-regular fa-user fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_uv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span><span id="busuanzi_container_site_pv" class="footer-divider" title='总访问量'><i class="fa-regular fa-eye fa-fw" aria-hidden="true"></i>&nbsp;<span id="busuanzi_value_site_pv"><i class="fa-solid fa-spinner fa-spin fa-fw" aria-hidden="true"></i></span></span>
        </div></div>
  </footer></div><div class="widgets"><div class="fixed-buttons animate__faster d-none"><div class="fixed-button back-to-top" role="button" aria-label="回到顶部"><i class="fa-solid fa-arrow-up fa-fw" aria-hidden="true"></i><span class="variant-numeric d-none">0%</span>
        </div></div><div id="mask"></div><noscript>
    <div class="noscript-warning">FixIt 主题在启用 JavaScript 的情况下效果最佳。</div>
  </noscript>
</div><link rel="stylesheet" href="/lib/lightgallery/css/lightgallery-bundle.min.css"><link rel="preload" href="/lib/katex/katex.min.css" as="style" onload="this.removeAttribute('onload');this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="/lib/katex/katex.min.css"></noscript><link rel="stylesheet" href="/lib/cookieconsent/cookieconsent.min.css"><script src="/lib/autocomplete/autocomplete.min.js" defer></script><script src="/lib/lunr/lunr.min.js" defer></script><script src="/lib/lunr/lunr.stemmer.support.min.js" defer></script><script src="/lib/lunr/lunr.zh.min.js" defer></script><script src="/lib/lightgallery/lightgallery.min.js" defer></script><script src="/lib/lightgallery/plugins/thumbnail/lg-thumbnail.min.js" defer></script><script src="/lib/lightgallery/plugins/zoom/lg-zoom.min.js" defer></script><script src="/lib/sharer/sharer.min.js" async defer></script><script src="/lib/katex/katex.min.js" defer></script><script src="/lib/katex/auto-render.min.js" defer></script><script src="/lib/katex/mhchem.min.js" defer></script><script src="/lib/cookieconsent/cookieconsent.min.js" defer></script><script src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async defer></script><script>window.config={"code":{"copyTitle":"复制到剪贴板","editLockTitle":"锁定可编辑代码块","editUnLockTitle":"解锁可编辑代码块","editable":true,"maxShownLines":30},"comment":{"enable":false},"cookieconsent":{"content":{"dismiss":"同意","link":"了解更多","message":"本网站使用 Cookies 来改善您的浏览体验。"},"enable":true,"palette":{"button":{"background":"#f0f0f0"},"popup":{"background":"#1aa3ff"}},"theme":"edgeless"},"enablePWA":true,"lightgallery":true,"math":{"delimiters":[{"display":true,"left":"$$","right":"$$"},{"display":true,"left":"\\[","right":"\\]"},{"display":true,"left":"\\begin{equation}","right":"\\end{equation}"},{"display":true,"left":"\\begin{equation*}","right":"\\end{equation*}"},{"display":true,"left":"\\begin{align}","right":"\\end{align}"},{"display":true,"left":"\\begin{align*}","right":"\\end{align*}"},{"display":true,"left":"\\begin{alignat}","right":"\\end{alignat}"},{"display":true,"left":"\\begin{alignat*}","right":"\\end{alignat*}"},{"display":true,"left":"\\begin{gather}","right":"\\end{gather}"},{"display":true,"left":"\\begin{CD}","right":"\\end{CD}"},{"display":false,"left":"$","right":"$"},{"display":false,"left":"\\(","right":"\\)"}],"strict":false},"search":{"highlightTag":"em","lunrIndexURL":"/index.json","lunrLanguageCode":"zh","lunrSegmentitURL":"/lib/lunr/lunr.segmentit.js","maxResultLength":10,"noResultsFound":"没有找到结果","snippetLength":50,"type":"lunr"}};</script><script src="/js/theme.min.js" defer></script></body>
</html>
